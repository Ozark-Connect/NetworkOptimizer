server {
    server_name _;
    listen 3000 reuseport;
    listen [::]:3000 reuseport;

    root /usr/share/nginx/html;
    index index.html;
    client_max_body_size 50m;
    error_page 405 =200 $uri;
    access_log off;
    gzip off;
    fastcgi_read_timeout 999;
    log_not_found off;
    server_tokens off;
    error_log /dev/null;
    tcp_nodelay on;
    tcp_nopush on;
    sendfile on;
    open_file_cache max=200000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors off;

    # Upload endpoint - reads entire POST body before responding.
    # Without this, the error_page 405 hack responds before the body is
    # fully received, causing ERR_CONNECTION_RESET behind reverse proxies.
    location = /upload {
        add_header 'Access-Control-Allow-Origin' "*" always;
        add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header Cache-Control 'no-store, no-cache, max-age=0, no-transform';

        client_body_buffer_size 35m;
        client_max_body_size 50m;

        # Don't forward the body to upstream - just drain it and get a 200 back
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_pass http://127.0.0.1:3000/upload-sink;
        proxy_set_header Host $host;
    }

    location = /upload-sink {
        add_header 'Access-Control-Allow-Origin' "*" always;
        return 200;
    }

    location / {
        add_header 'Access-Control-Allow-Origin' "*" always;
        add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header Cache-Control 'no-store, no-cache, max-age=0, no-transform';
        add_header Last-Modified $date_gmt;
        if_modified_since off;
        expires off;
        etag off;

        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Credentials' "true";
            add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With' always;
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Methods' "GET, POST, OPTIONS" always;
            return 200;
        }
    }

    # Static assets - match OpenSpeedTest config exactly
    location ~* ^.+\.(?:css|cur|js|jpe?g|gif|htc|ico|png|html|xml|otf|ttf|eot|woff|woff2|svg)$ {
        access_log off;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Vary Accept-Encoding;
        tcp_nodelay off;
        open_file_cache max=3000 inactive=120s;
        open_file_cache_valid 45s;
        open_file_cache_min_uses 2;
        open_file_cache_errors off;
        gzip on;
        gzip_disable "msie6";
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_http_version 1.1;
        gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;
    }
}
