<?xml version="1.0" encoding="UTF-8"?>

<!--
  Network Optimizer - Service Component

  Installs the main NetworkOptimizer.Web.exe as a Windows Service
  with firewall exceptions for ports 8042 (web UI) and 5201 (iperf3).
-->

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:fw="http://wixtoolset.org/schemas/v4/wxs/firewall">

  <Fragment>
    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">

      <!-- Main executable and service registration -->
      <Component Id="NetworkOptimizerService" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890" Bitness="always64">
        <File Id="NetworkOptimizerExe"
              Source="$(var.PublishDir)NetworkOptimizer.Web.exe"
              KeyPath="yes" />

        <!-- Install as Windows Service -->
        <!-- Using LocalSystem for write access to Program Files (nginx config.js generation) -->
        <ServiceInstall
            Id="NetworkOptimizerServiceInstall"
            Name="NetworkOptimizer"
            DisplayName="Network Optimizer"
            Description="UniFi network analysis, security auditing, and SQM optimization service"
            Type="ownProcess"
            Start="auto"
            ErrorControl="normal"
            Account="LocalSystem">
          <!-- Delayed auto-start for better boot performance -->
          <ServiceConfig DelayedAutoStart="yes" OnInstall="yes" OnReinstall="yes" />
        </ServiceInstall>

        <!-- Service control: start on install, stop/remove on uninstall -->
        <ServiceControl
            Id="NetworkOptimizerServiceControl"
            Name="NetworkOptimizer"
            Start="install"
            Stop="both"
            Remove="uninstall"
            Wait="yes" />

        <!-- Firewall exception for Web UI (port 8042) -->
        <fw:FirewallException
            Id="WebUIFirewall"
            Name="Network Optimizer Web UI"
            Port="8042"
            Protocol="tcp"
            Scope="any"
            Profile="all" />

        <!-- Firewall exception for iperf3 (port 5201) -->
        <fw:FirewallException
            Id="Iperf3Firewall"
            Name="Network Optimizer iperf3"
            Port="5201"
            Protocol="tcp"
            Scope="any"
            Profile="all" />
      </Component>

      <!-- Logs folder - removed on uninstall (logs are regenerated) -->
      <Component Id="LogsFolderComponent" Directory="LogsFolder" Guid="0AE8CCD8-799F-45EB-B0F8-BD9F41B0700D" Bitness="always64">
        <CreateFolder />
        <RemoveFile Id="RemoveLogFiles" On="uninstall" Directory="LogsFolder" Name="*.*" />
        <RemoveFolder Id="RemoveLogsOnUninstall" On="uninstall" />
      </Component>

      <!-- Data folder - preserved by default on uninstall
           For clean uninstall: msiexec /x {ProductCode} REMOVEDATA=1 -->
      <Component Id="DataFolderComponent" Directory="DataFolder" Guid="188E9575-59EC-4BB0-BF7A-0FC10646DF69" Bitness="always64">
        <CreateFolder />
      </Component>

      <!-- Registry settings (read by NginxHostedService for config.js generation) -->
      <Component Id="RegistrySettings" Guid="0EFB0540-977F-48F1-A4D6-AF6DD6B5B45B" Bitness="always64">
        <RegistryKey Root="HKLM" Key="SOFTWARE\Ozark Connect\Network Optimizer">
          <!-- HOST_IP - Server IP address for path analysis -->
          <RegistryValue Name="HOST_IP" Type="string" Value="[HOST_IP]" />
          <!-- HOST_NAME - Server hostname (requires DNS) -->
          <RegistryValue Name="HOST_NAME" Type="string" Value="[HOST_NAME]" />
          <!-- REVERSE_PROXIED_HOST_NAME - HTTPS reverse proxy hostname -->
          <RegistryValue Name="REVERSE_PROXIED_HOST_NAME" Type="string" Value="[REVERSE_PROXIED_HOST_NAME]" />
          <!-- IPERF3_SERVER_ENABLED - Enable iperf3 server on port 5201 -->
          <RegistryValue Name="IPERF3_SERVER_ENABLED" Type="string" Value="[IPERF3_SERVER_ENABLED]" />
          <!-- OPENSPEEDTEST_PORT - nginx port for OpenSpeedTest (default 3005) -->
          <RegistryValue Name="OPENSPEEDTEST_PORT" Type="string" Value="[OPENSPEEDTEST_PORT]" KeyPath="yes" />
          <!-- OPENSPEEDTEST_HOST - Separate hostname for SpeedTest if different -->
          <RegistryValue Name="OPENSPEEDTEST_HOST" Type="string" Value="[OPENSPEEDTEST_HOST]" />
          <!-- OPENSPEEDTEST_HTTPS - Enable HTTPS for SpeedTest (behind TLS proxy) -->
          <RegistryValue Name="OPENSPEEDTEST_HTTPS" Type="string" Value="[OPENSPEEDTEST_HTTPS]" />
          <!-- OPENSPEEDTEST_HTTP_PORT - Proxy HTTP port for mobile mode (default 80) -->
          <RegistryValue Name="OPENSPEEDTEST_HTTP_PORT" Type="string" Value="[OPENSPEEDTEST_HTTP_PORT]" />
          <!-- OPENSPEEDTEST_HTTPS_PORT - Proxy HTTPS port (default 443) -->
          <RegistryValue Name="OPENSPEEDTEST_HTTPS_PORT" Type="string" Value="[OPENSPEEDTEST_HTTPS_PORT]" />
          <!-- Traefik settings (optional HTTPS reverse proxy) -->
          <RegistryValue Name="TRAEFIK_ACME_EMAIL" Type="string" Value="[TRAEFIK_ACME_EMAIL]" />
          <RegistryValue Name="TRAEFIK_CF_DNS_API_TOKEN" Type="string" Value="[TRAEFIK_CF_DNS_API_TOKEN]" />
          <RegistryValue Name="TRAEFIK_OPTIMIZER_HOSTNAME" Type="string" Value="[TRAEFIK_OPTIMIZER_HOSTNAME]" />
          <RegistryValue Name="TRAEFIK_SPEEDTEST_HOSTNAME" Type="string" Value="[TRAEFIK_SPEEDTEST_HOSTNAME]" />
          <RegistryValue Name="TRAEFIK_LISTEN_IP" Type="string" Value="[TRAEFIK_LISTEN_IP]" />
          <RegistryValue Name="TRAEFIK_LOG_LEVEL" Type="string" Value="[TRAEFIK_LOG_LEVEL]" />
        </RegistryKey>
      </Component>

    </ComponentGroup>

    <!-- All published files from dotnet publish (auto-harvested) -->
    <ComponentGroup Id="PublishedFiles" Directory="INSTALLFOLDER">
      <!-- Use Files element to automatically include all files from publish directory -->
      <Files Include="$(var.PublishDir)**">
        <!-- Exclude the main exe (already included above with service registration) -->
        <Exclude Files="$(var.PublishDir)NetworkOptimizer.Web.exe" />
      </Files>
    </ComponentGroup>

  </Fragment>

</Wix>
