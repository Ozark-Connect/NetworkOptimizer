using System.Text.Json;
using NetworkOptimizer.Threats.Models;

namespace NetworkOptimizer.Threats.Analysis;

/// <summary>
/// Detects exploit campaigns: multiple source IPs from the same /24 subnet targeting
/// the same destination port + signature ID within 1 hour.
/// </summary>
public class ExploitCampaignDetector
{
    private const int MinDistinctSources = 3;
    private static readonly TimeSpan Window = TimeSpan.FromHours(1);

    public List<ThreatPattern> Detect(List<ThreatEvent> events)
    {
        var patterns = new List<ThreatPattern>();

        // Filter to exploitation events
        var exploitEvents = events
            .Where(e => e.KillChainStage is KillChainStage.AttemptedExploitation or KillChainStage.ActiveExploitation)
            .ToList();

        // Group by target port + signature
        var groups = exploitEvents
            .GroupBy(e => new { e.DestPort, e.SignatureId });

        foreach (var group in groups)
        {
            var ordered = group.OrderBy(e => e.Timestamp).ToList();
            if (ordered.Count < MinDistinctSources) continue;

            // Check for /24 subnet clustering within the window
            var windowStart = 0;
            for (var i = 0; i < ordered.Count; i++)
            {
                while (windowStart < i && ordered[i].Timestamp - ordered[windowStart].Timestamp > Window)
                    windowStart++;

                var windowEvents = ordered.Skip(windowStart).Take(i - windowStart + 1).ToList();

                // Group by /24 subnet
                var subnetGroups = windowEvents
                    .GroupBy(e => GetSubnet24(e.SourceIp))
                    .Where(sg => sg.Key != null);

                foreach (var subnet in subnetGroups)
                {
                    var distinctSources = subnet.Select(e => e.SourceIp).Distinct().Count();
                    if (distinctSources >= MinDistinctSources)
                    {
                        var sourceIps = subnet.Select(e => e.SourceIp).Distinct().OrderBy(ip => ip).ToList();
                        patterns.Add(new ThreatPattern
                        {
                            PatternType = PatternType.ExploitCampaign,
                            DetectedAt = DateTime.UtcNow,
                            DedupKey = $"ec:{subnet.Key}:{group.Key.DestPort}",
                            SourceIpsJson = JsonSerializer.Serialize(sourceIps),
                            TargetPort = group.Key.DestPort,
                            EventCount = subnet.Count(),
                            FirstSeen = subnet.Min(e => e.Timestamp),
                            LastSeen = subnet.Max(e => e.Timestamp),
                            Confidence = Math.Min(1.0, distinctSources / 10.0),
                            Description = $"Coordinated exploit campaign from {subnet.Key}/24: {distinctSources} sources targeting port {group.Key.DestPort}"
                        });
                        goto nextGroup; // One pattern per port+signature combination
                    }
                }
            }
            nextGroup:;
        }

        return patterns;
    }

    private static string? GetSubnet24(string ip)
    {
        var parts = ip.Split('.');
        if (parts.Length != 4) return null;
        return $"{parts[0]}.{parts[1]}.{parts[2]}";
    }
}
