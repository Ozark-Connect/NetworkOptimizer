@using NetworkOptimizer.Web.Services
@inject IAdminAuthService AdminAuth

<div class="card" id="admin-password">
    <div class="card-header">
        <h2 class="card-title">Admin Password</h2>
        <span class="status-badge status-@(_adminPasswordSource == AdminPasswordSource.None ? "disconnected" : "connected")">
            @GetAdminPasswordSourceLabel()
        </span>
    </div>
    <div class="card-body">
        <p class="section-description">
            Set an admin password to protect access to this application. The password can be configured here
            (stored encrypted in the database) or via the <code>APP_PASSWORD</code> environment variable.
            Database password takes priority when enabled.
        </p>

        <div class="info-row" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
            <span class="info-label">Current Source:</span>
            <span class="info-value">
                @switch (_adminPasswordSource)
                {
                    case AdminPasswordSource.Database:
                        <span style="color: var(--success);">Database (User Configured)</span>
                        break;
                    case AdminPasswordSource.Environment:
                        <span style="color: var(--warning);">Environment Variable (APP_PASSWORD)</span>
                        break;
                    case AdminPasswordSource.AutoGenerated:
                        <span style="color: var(--warning);">Auto-Generated (see startup logs)</span>
                        break;
                    case AdminPasswordSource.None:
                        <span style="color: var(--danger);">Not Configured</span>
                        break;
                }
            </span>
        </div>

        <div class="form-group">
            <label class="form-label">New Password</label>
            <input type="password" class="form-control" @bind="_adminNewPassword" @bind:event="oninput" @bind:after="OnAdminPasswordInput" placeholder="Enter new password" autocomplete="new-password" />
        </div>

        <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <input type="password" class="form-control" @bind="_adminConfirmPassword" @bind:event="oninput" @bind:after="OnAdminPasswordInput" placeholder="Confirm new password" autocomplete="new-password" />
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" @onclick="SaveAdminPassword" disabled="@_savingAdminPassword">
                @if (_savingAdminPassword)
                {
                    <span class="spinner"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save Password</span>
                }
            </button>
            @if (_adminPasswordSource == AdminPasswordSource.Database)
            {
                <button class="btn btn-warning" @onclick="ClearAdminPassword" disabled="@_savingAdminPassword">
                    Clear Database Password
                </button>
            }
        </div>

        @if (!string.IsNullOrEmpty(_adminPasswordMessage))
        {
            <div class="alert alert-@_adminPasswordMessageClass">
                @_adminPasswordMessage
            </div>
        }
    </div>
</div>

@code {
    private AdminPasswordSource _adminPasswordSource = AdminPasswordSource.None;
    private string _adminNewPassword = "";
    private string _adminConfirmPassword = "";
    private bool _savingAdminPassword = false;
    private string _adminPasswordMessage = "";
    private string _adminPasswordMessageClass = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadAdminPasswordSettings();
    }

    private async Task LoadAdminPasswordSettings()
    {
        try
        {
            _adminPasswordSource = await AdminAuth.GetPasswordSourceAsync();
        }
        catch (Exception ex)
        {
            _adminPasswordMessage = $"Error loading admin settings: {ex.Message}";
            _adminPasswordMessageClass = "danger";
        }
    }

    private string GetAdminPasswordSourceLabel()
    {
        return _adminPasswordSource switch
        {
            AdminPasswordSource.Database => "Database",
            AdminPasswordSource.Environment => "Env Var",
            AdminPasswordSource.AutoGenerated => "Auto-Gen",
            AdminPasswordSource.None => "Not Set",
            _ => "Unknown"
        };
    }

    private void OnAdminPasswordInput()
    {
        if (!string.IsNullOrEmpty(_adminPasswordMessage))
        {
            _adminPasswordMessage = "";
        }
    }

    private async Task SaveAdminPassword()
    {
        var validation = AdminAuth.ValidateNewPassword(_adminNewPassword, _adminConfirmPassword);
        if (!validation.IsValid)
        {
            _adminPasswordMessage = validation.ErrorMessage ?? "Invalid password";
            _adminPasswordMessageClass = "danger";
            StateHasChanged();
            return;
        }

        _savingAdminPassword = true;
        _adminPasswordMessage = "";
        StateHasChanged();

        try
        {
            var passwordToSave = string.IsNullOrEmpty(_adminNewPassword) ? null : _adminNewPassword;
            await AdminAuth.SaveAdminSettingsAsync(passwordToSave, true);

            _adminPasswordSource = await AdminAuth.GetPasswordSourceAsync();

            _adminNewPassword = "";
            _adminConfirmPassword = "";
            _adminPasswordMessage = "Admin password settings saved successfully";
            _adminPasswordMessageClass = "success";
        }
        catch (Exception ex)
        {
            _adminPasswordMessage = $"Error saving admin password: {ex.Message}";
            _adminPasswordMessageClass = "danger";
        }
        finally
        {
            _savingAdminPassword = false;
            StateHasChanged();
        }
    }

    private async Task ClearAdminPassword()
    {
        _savingAdminPassword = true;
        _adminPasswordMessage = "";
        StateHasChanged();

        try
        {
            await AdminAuth.ClearDatabasePasswordAsync();
            _adminPasswordSource = await AdminAuth.GetPasswordSourceAsync();

            if (_adminPasswordSource == AdminPasswordSource.Environment)
            {
                _adminPasswordMessage = "Database password cleared. Now using environment variable (APP_PASSWORD)";
            }
            else
            {
                _adminPasswordMessage = "Database password cleared. A new auto-generated password has been created - check the application logs.";
            }
            _adminPasswordMessageClass = "success";
        }
        catch (Exception ex)
        {
            _adminPasswordMessage = $"Error clearing password: {ex.Message}";
            _adminPasswordMessageClass = "danger";
        }
        finally
        {
            _savingAdminPassword = false;
            StateHasChanged();
        }
    }
}
