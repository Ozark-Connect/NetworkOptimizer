@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Web.Components.Shared
@inject UniFiSshService SshService
@inject UniFiConnectionService ConnectionService

<div class="card" id="device-ssh">
    <div class="card-header">
        <h2 class="card-title">Device SSH</h2>
        <span class="status-badge status-@(_sshSettings?.Enabled == true ? "connected" : "disconnected")">
            @(_sshSettings?.Enabled == true ? "Configured" : "Not Configured")
        </span>
    </div>
    <div class="card-body">
        <p class="section-description">
            Configure shared SSH credentials for UniFi network devices (Access Points, Switches, Modems).
            All UniFi devices on a network share the same SSH credentials.
            These credentials are used for cellular modem monitoring and speed tests, and provide the
            default credentials for custom speed test devices.
        </p>

        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label class="form-label">Port</label>
                <input type="number" class="form-control" @bind="_sshPort" />
            </div>
            <div class="form-group" style="flex: 2;">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" @bind="_sshUsername" placeholder="Your Device SSH username" autocomplete="off" data-1p-ignore data-lpignore="true" data-bwignore />
                <small class="form-help">Set in UniFi Network (see below for instructions), usually randomly generated by default</small>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" @bind="_sshPassword" placeholder="@(!string.IsNullOrWhiteSpace(_sshPrivateKeyPath) ? "(using SSH key)" : _hasSshPassword ? "Saved â€“ enter new to update" : "Enter password")" autocomplete="new-password" data-1p-ignore data-lpignore="true" data-bwignore />
        </div>

        <div class="form-group">
            <label class="form-label">Private Key Path (alternative to password)</label>
            <input type="text" class="form-control" @bind="_sshPrivateKeyPath" placeholder="/app/ssh-keys/id_rsa" />
            <small class="form-help">Leave blank to use password authentication</small>
        </div>

        <div class="form-group">
            <label class="form-check">
                <input type="checkbox" @bind="_sshEnabled" />
                <span>Enable SSH access for device operations</span>
            </label>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" @onclick="SaveSshSettings" disabled="@_savingSshSettings">
                @if (_savingSshSettings)
                {
                    <span class="spinner"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save SSH Settings</span>
                }
            </button>
            <button class="btn btn-secondary" @onclick="TestSshConnection" disabled="@_testingSshConnection">
                @if (_testingSshConnection)
                {
                    <span class="spinner"></span>
                    <span>Testing...</span>
                }
                else
                {
                    <span>Test Connection</span>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(_sshMessage))
        {
            <div class="alert alert-@_sshMessageClass alert-with-tooltip">
                <span class="alert-text">@_sshMessage</span>
                @if (_sshMessageClass == "danger")
                {
                    <SshTroubleshootingTooltip Context="devices" HideSettingsLink="true" />
                }
            </div>
        }

        @if (_sshSettings?.LastTestedAt != null)
        {
            <div class="form-help" style="margin-top: 1rem;">
                Last tested: @_sshSettings.LastTestedAt?.ToLocalTime().ToString("g") - @_sshSettings.LastTestResult
            </div>
        }

        <details class="setup-guide" open="@(_sshSettings?.Enabled != true)">
            <summary>How to Enable UniFi Device SSH</summary>
            <div class="setup-guide-content">
                <ol>
                    <li>Open UniFi Network: <code>https://&lt;gateway-ip&gt;</code> or <code>https://unifi.ui.com</code></li>
                    <li>Sign in to your Console</li>
                    <li>Click <strong>UniFi Devices</strong> on the side menu</li>
                    <li>In the left-hand filter menu, select <strong>Device Updates and Settings</strong> at the bottom</li>
                    <li>Expand <strong>Device SSH Settings</strong> at the bottom</li>
                    <li>Check <strong>Device SSH Authentication</strong></li>
                    <li>Set a username and secure password (optionally add SSH public keys)</li>
                    <li>Save</li>
                </ol>
                <p><strong>Note:</strong> This is a separate credential from Gateway SSH.</p>
            </div>
        </details>
    </div>
</div>

@code {
    [Parameter]
    public int SiteId { get; set; }

    [Parameter]
    public EventCallback OnSettingsChanged { get; set; }

    private UniFiSshSettings? _sshSettings;
    private string _sshUsername = "";
    private string _sshPassword = "";
    private string _sshPrivateKeyPath = "";
    private int _sshPort = 22;
    private bool _sshEnabled = true;
    private bool _savingSshSettings = false;
    private bool _testingSshConnection = false;
    private string _sshMessage = "";
    private string _sshMessageClass = "";
    private bool _hasSshPassword = false;

    public bool HasCredentials => _sshSettings?.HasCredentials == true;

    protected override async Task OnInitializedAsync()
    {
        await LoadSshSettings();
    }

    private async Task LoadSshSettings()
    {
        try
        {
            _sshSettings = await SshService.GetSettingsAsync(SiteId);
            _sshUsername = _sshSettings.Username;
            _sshPort = _sshSettings.Port;
            _sshPrivateKeyPath = _sshSettings.PrivateKeyPath ?? "";
            _sshEnabled = _sshSettings.Enabled;
            _hasSshPassword = !string.IsNullOrEmpty(_sshSettings.Password);
        }
        catch (Exception ex)
        {
            _sshMessage = $"Error loading SSH settings: {ex.Message}";
            _sshMessageClass = "danger";
        }
    }

    private async Task SaveSshSettings()
    {
        if (string.IsNullOrWhiteSpace(_sshUsername))
        {
            _sshMessage = "Username is required";
            _sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        var hasPassword = !string.IsNullOrEmpty(_sshPassword) || _hasSshPassword;
        var hasPrivateKey = !string.IsNullOrWhiteSpace(_sshPrivateKeyPath);
        if (!hasPassword && !hasPrivateKey)
        {
            _sshMessage = "Either a password or private key path is required";
            _sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        _savingSshSettings = true;
        _sshMessage = "";
        StateHasChanged();

        try
        {
            var settings = _sshSettings ?? new UniFiSshSettings();
            settings.Username = _sshUsername;
            settings.Port = _sshPort;
            settings.PrivateKeyPath = string.IsNullOrWhiteSpace(_sshPrivateKeyPath) ? null : _sshPrivateKeyPath;
            settings.Enabled = _sshEnabled;

            if (!string.IsNullOrWhiteSpace(_sshPrivateKeyPath))
            {
                settings.Password = null;
            }
            else if (!string.IsNullOrEmpty(_sshPassword))
            {
                settings.Password = _sshPassword;
            }

            _sshSettings = await SshService.SaveSettingsAsync(SiteId, settings);
            _sshPassword = "";
            _hasSshPassword = !string.IsNullOrEmpty(_sshSettings.Password);
            _sshMessage = "SSH settings saved successfully";
            _sshMessageClass = "success";

            await OnSettingsChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            _sshMessage = $"Error saving SSH settings: {ex.Message}";
            _sshMessageClass = "danger";
        }
        finally
        {
            _savingSshSettings = false;
            StateHasChanged();
        }
    }

    private async Task TestSshConnection()
    {
        if (string.IsNullOrWhiteSpace(_sshUsername))
        {
            _sshMessage = "Username is required";
            _sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        var hasPassword = !string.IsNullOrEmpty(_sshPassword) || _hasSshPassword;
        var hasPrivateKey = !string.IsNullOrWhiteSpace(_sshPrivateKeyPath);
        if (!hasPassword && !hasPrivateKey)
        {
            _sshMessage = "Either a password or private key path is required";
            _sshMessageClass = "danger";
            StateHasChanged();
            return;
        }

        if (!ConnectionService.IsConnected(SiteId) || ConnectionService.GetClient(SiteId) == null)
        {
            _sshMessage = "Connect to UniFi controller first to find a device to test SSH against.";
            _sshMessageClass = "warning";
            StateHasChanged();
            return;
        }

        _testingSshConnection = true;
        _sshMessage = "Finding a device to test SSH...";
        _sshMessageClass = "info";
        StateHasChanged();

        try
        {
            var devices = await ConnectionService.GetDiscoveredDevicesAsync(SiteId);

            var testableTypes = new[]
            {
                NetworkOptimizer.Core.Enums.DeviceType.AccessPoint,
                NetworkOptimizer.Core.Enums.DeviceType.Switch,
                NetworkOptimizer.Core.Enums.DeviceType.CellularModem
            };

            var testDevice = devices
                .Where(d => testableTypes.Contains(d.Type)
                            && d.State == 1 && !string.IsNullOrEmpty(d.IpAddress))
                .FirstOrDefault();

            if (testDevice == null)
            {
                _sshMessage = "No online devices found. Ensure you have adopted APs, switches, or modems in your network.";
                _sshMessageClass = "warning";
                _testingSshConnection = false;
                StateHasChanged();
                return;
            }

            _sshMessage = $"Testing SSH connection to {testDevice.Name} ({testDevice.IpAddress})...";
            StateHasChanged();

            var testPassword = _sshPassword;
            if (string.IsNullOrEmpty(testPassword) && _hasSshPassword)
            {
                var savedSettings = await SshService.GetSettingsAsync(SiteId);
                testPassword = savedSettings?.Password;
            }

            var testConfig = new DeviceSshConfiguration
            {
                Host = testDevice.IpAddress,
                SshUsername = _sshUsername,
                SshPassword = testPassword,
                SshPrivateKeyPath = _sshPrivateKeyPath
            };

            var (success, message) = await SshService.TestConnectionAsync(SiteId, testConfig);
            if (success)
            {
                _sshMessage = $"SSH connection to {testDevice.Name} successful!";
                _sshMessageClass = "success";

                if (_sshSettings != null)
                {
                    _sshSettings.LastTestedAt = DateTime.UtcNow;
                    _sshSettings.LastTestResult = "Success";
                    await SshService.SaveSettingsAsync(SiteId, _sshSettings);
                }
            }
            else
            {
                _sshMessage = $"SSH connection failed: {message}";
                _sshMessageClass = "danger";
            }
        }
        catch (Exception ex)
        {
            _sshMessage = $"Error: {ex.Message}";
            _sshMessageClass = "danger";
        }
        finally
        {
            _testingSshConnection = false;
            StateHasChanged();
        }
    }
}
