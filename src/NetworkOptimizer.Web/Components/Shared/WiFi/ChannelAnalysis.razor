@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.WiFi
@using NetworkOptimizer.WiFi.Models
@inject WiFiOptimizerService WiFiService
@inject UniFiConnectionService ConnectionService

<div class="channel-analysis-container">
    <div class="channel-header">
        <h3>Channel Analysis</h3>
        <button class="btn btn-sm btn-secondary" @onclick="RefreshData" disabled="@_loading">
            @if (_loading)
            {
                <span class="spinner-sm"></span>
            }
            else
            {
                <span>Refresh</span>
            }
        </button>
    </div>

    @if (_loading)
    {
        <div class="channel-loading">
            <span class="spinner"></span>
            <span>Loading channel data...</span>
        </div>
    }
    else if (_accessPoints.Count == 0)
    {
        <div class="channel-empty">
            <p>No access points found. Connect to UniFi to analyze channel usage.</p>
        </div>
    }
    else
    {
        <!-- Summary Stats -->
        <div class="channel-stats-row">
            <div class="channel-stat-card @(_coChannelIssues > 0 ? "stat-warning" : "")">
                <div class="channel-stat-value">@_coChannelIssues</div>
                <div class="channel-stat-label">Co-Channel Issues</div>
            </div>
            <div class="channel-stat-card">
                <div class="channel-stat-value">@_channelsInUse.Count</div>
                <div class="channel-stat-label">Channels In Use</div>
            </div>
            <div class="channel-stat-card @GetUtilizationStatClass(_avgUtilization)">
                <div class="channel-stat-value">@_avgUtilization%</div>
                <div class="channel-stat-label">Avg Utilization</div>
            </div>
            <div class="channel-stat-card @GetInterferenceStatClass(_avgInterference)">
                <div class="channel-stat-value">@_avgInterference%</div>
                <div class="channel-stat-label">Avg Interference</div>
            </div>
        </div>

        <!-- Band Tabs -->
        <div class="band-tabs">
            @foreach (var band in _bands)
            {
                var bandData = GetBandData(band);
                <button class="band-tab @(_selectedBand == band ? "active" : "") @(bandData.HasIssues ? "has-issues" : "")"
                        @onclick="() => _selectedBand = band">
                    @band.ToDisplayString()
                    @if (bandData.HasIssues)
                    {
                        <span class="issue-indicator">!</span>
                    }
                </button>
            }
        </div>

        <!-- Channel Map for Selected Band -->
        <div class="channel-map-section">
            <div class="section-header">
                <h4>@_selectedBand.ToDisplayString() Channel Map</h4>
                <span class="section-subtitle">@GetBandDescription(_selectedBand)</span>
            </div>

            <div class="channel-map">
                @foreach (var channel in GetChannelsForBand(_selectedBand))
                {
                    var apsOnChannel = GetApsOnChannel(_selectedBand, channel);
                    var isOccupied = apsOnChannel.Any();
                    var hasOverlap = apsOnChannel.Count > 1;
                    var utilization = GetChannelUtilization(_selectedBand, channel);
                    var interference = GetChannelInterference(_selectedBand, channel);

                    <div class="channel-slot @(isOccupied ? "occupied" : "") @(hasOverlap ? "overlap" : "")"
                         @onclick="() => SelectChannel(_selectedBand, channel)">
                        <div class="channel-number">@channel</div>
                        @if (isOccupied)
                        {
                            <div class="channel-aps">
                                @foreach (var ap in apsOnChannel.Take(3))
                                {
                                    <div class="channel-ap-dot" data-tooltip="@ap.Name"></div>
                                }
                                @if (apsOnChannel.Count > 3)
                                {
                                    <div class="channel-ap-more">+@(apsOnChannel.Count - 3)</div>
                                }
                            </div>
                            <div class="channel-metrics">
                                <span class="channel-util @GetUtilizationClass(utilization)">@utilization%</span>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Non-overlapping Channel Indicators (2.4 GHz only) -->
            @if (_selectedBand == RadioBand.Band2_4GHz)
            {
                <div class="channel-recommendations">
                    <span class="rec-label">Recommended non-overlapping:</span>
                    <span class="rec-channels">1, 6, 11</span>
                </div>
            }
        </div>

        <!-- Selected Channel Details or AP List -->
        @if (_selectedChannel != null)
        {
            var apsOnChannel = GetApsOnChannel(_selectedBand, _selectedChannel.Value);
            <div class="channel-details-section">
                <div class="section-header">
                    <h4>Channel @_selectedChannel Details</h4>
                    <button class="btn btn-sm btn-ghost" @onclick="() => _selectedChannel = null">Close</button>
                </div>

                @if (apsOnChannel.Count > 1)
                {
                    <div class="overlap-warning">
                        <span class="warning-icon">!</span>
                        <span>@apsOnChannel.Count APs are on the same channel - this may cause co-channel interference</span>
                    </div>
                }

                <div class="channel-aps-list">
                    @foreach (var ap in apsOnChannel)
                    {
                        var radio = ap.Radios.FirstOrDefault(r => r.Band == _selectedBand && r.Channel == _selectedChannel);
                        <div class="channel-ap-card">
                            <div class="ap-info">
                                <span class="ap-name"><DeviceIcon Model="@ap.Model" Size="sm" /> @ap.Name</span>
                                <span class="ap-model">@ap.Model</span>
                            </div>
                            <div class="ap-radio-details">
                                @if (radio != null)
                                {
                                    <div class="detail-item">
                                        <span class="detail-label">Width:</span>
                                        <span class="detail-value">@(radio.ChannelWidth ?? 20) MHz</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">TX Power:</span>
                                        <span class="detail-value">@(radio.TxPower?.ToString() ?? "-") dBm</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Utilization:</span>
                                        <span class="detail-value @GetUtilizationClass(radio.ChannelUtilization ?? 0)">
                                            @(radio.ChannelUtilization?.ToString() ?? "-")%
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Interference:</span>
                                        <span class="detail-value @GetInterferenceClass(radio.Interference ?? 0)">
                                            @(radio.Interference?.ToString() ?? "-")%
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Clients:</span>
                                        <span class="detail-value">@(radio.ClientCount?.ToString() ?? "-")</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Satisfaction:</span>
                                        <span class="detail-value @GetSatisfactionClass(radio.Satisfaction ?? 0)">
                                            @(radio.Satisfaction?.ToString() ?? "-")%
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <!-- All APs Table for Selected Band -->
            <div class="aps-band-section">
                <div class="section-header">
                    <h4>@_selectedBand.ToDisplayString() Radios</h4>
                </div>

                <div class="aps-band-table">
                    <div class="aps-header">
                        <div class="ap-col ap-name-col">Access Point</div>
                        <div class="ap-col ap-channel-col">Channel</div>
                        <div class="ap-col ap-width-col">Width</div>
                        <div class="ap-col ap-power-col">TX Power</div>
                        <div class="ap-col ap-util-col">Utilization</div>
                        <div class="ap-col ap-interf-col">Interference</div>
                        <div class="ap-col ap-clients-col">Clients</div>
                    </div>
                    @foreach (var ap in _accessPoints)
                    {
                        var radio = ap.Radios.FirstOrDefault(r => r.Band == _selectedBand);
                        @if (radio != null)
                        {
                            <div class="aps-row">
                                <div class="ap-col ap-name-col">
                                    <span class="ap-name"><DeviceIcon Model="@ap.Model" Size="sm" /> @ap.Name</span>
                                    <span class="ap-model">@ap.Model</span>
                                </div>
                                <div class="ap-col ap-channel-col">
                                    <span class="channel-badge @(IsChannelOverlapped(_selectedBand, radio.Channel) ? "overlap" : "")">
                                        @(radio.Channel?.ToString() ?? "-")
                                    </span>
                                </div>
                                <div class="ap-col ap-width-col">@(radio.ChannelWidth ?? 20) MHz</div>
                                <div class="ap-col ap-power-col">
                                    <span class="power-value">@(radio.TxPower?.ToString() ?? "-")</span>
                                    @if (!string.IsNullOrEmpty(radio.TxPowerMode))
                                    {
                                        <span class="power-mode">(@radio.TxPowerMode)</span>
                                    }
                                </div>
                                <div class="ap-col ap-util-col">
                                    <div class="util-bar-container">
                                        <div class="util-bar @GetUtilizationClass(radio.ChannelUtilization ?? 0)"
                                             style="width: @(radio.ChannelUtilization ?? 0)%"></div>
                                    </div>
                                    <span class="util-value">@(radio.ChannelUtilization?.ToString() ?? "-")%</span>
                                </div>
                                <div class="ap-col ap-interf-col @GetInterferenceClass(radio.Interference ?? 0)">
                                    @(radio.Interference?.ToString() ?? "-")%
                                </div>
                                <div class="ap-col ap-clients-col">@(radio.ClientCount?.ToString() ?? "0")</div>
                            </div>
                        }
                    }
                </div>
            </div>
        }

        <!-- Issues/Recommendations -->
        @if (_channelIssues.Count > 0)
        {
            <div class="channel-issues-section">
                <div class="section-header">
                    <h4>Channel Issues</h4>
                </div>

                <div class="issues-list">
                    @foreach (var issue in _channelIssues)
                    {
                        <div class="issue-item @issue.Severity">
                            <div class="issue-icon">@(issue.Severity == "warning" ? "!" : "i")</div>
                            <div class="issue-content">
                                <div class="issue-title">@issue.Title</div>
                                <div class="issue-description">@issue.Description</div>
                                @if (!string.IsNullOrEmpty(issue.Recommendation))
                                {
                                    <div class="issue-recommendation">@issue.Recommendation</div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private bool _loading = true;
    private List<AccessPointSnapshot> _accessPoints = new();
    private RadioBand _selectedBand = RadioBand.Band5GHz;
    private int? _selectedChannel;

    // Calculated stats
    private int _coChannelIssues;
    private int _avgUtilization;
    private int _avgInterference;
    private HashSet<int> _channelsInUse = new();
    private List<ChannelIssue> _channelIssues = new();

    private readonly RadioBand[] _bands = { RadioBand.Band2_4GHz, RadioBand.Band5GHz, RadioBand.Band6GHz };

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _accessPoints = await WiFiService.GetAccessPointsAsync();
            AnalyzeChannels();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _accessPoints = await WiFiService.GetAccessPointsAsync(forceRefresh: true);
            AnalyzeChannels();
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void AnalyzeChannels()
    {
        _channelIssues.Clear();
        _channelsInUse.Clear();
        _coChannelIssues = 0;

        var allRadios = _accessPoints.SelectMany(ap => ap.Radios).ToList();

        // Calculate averages
        var utilizationValues = allRadios.Where(r => r.ChannelUtilization.HasValue).Select(r => r.ChannelUtilization!.Value).ToList();
        var interferenceValues = allRadios.Where(r => r.Interference.HasValue).Select(r => r.Interference!.Value).ToList();

        _avgUtilization = utilizationValues.Count > 0 ? (int)utilizationValues.Average() : 0;
        _avgInterference = interferenceValues.Count > 0 ? (int)interferenceValues.Average() : 0;

        // Track channels in use
        foreach (var radio in allRadios.Where(r => r.Channel.HasValue))
        {
            _channelsInUse.Add(radio.Channel!.Value);
        }

        // Find co-channel issues per band
        foreach (var band in _bands)
        {
            var radiosInBand = allRadios.Where(r => r.Band == band && r.Channel.HasValue).ToList();
            var channelGroups = radiosInBand.GroupBy(r => r.Channel!.Value).Where(g => g.Count() > 1).ToList();

            foreach (var group in channelGroups)
            {
                _coChannelIssues++;
                var apNames = _accessPoints
                    .Where(ap => ap.Radios.Any(r => r.Band == band && r.Channel == group.Key))
                    .Select(ap => ap.Name)
                    .ToList();

                _channelIssues.Add(new ChannelIssue
                {
                    Severity = "warning",
                    Title = $"Co-Channel Interference on {band.ToDisplayString()} Channel {group.Key}",
                    Description = $"{group.Count()} APs ({string.Join(", ", apNames)}) are using the same channel.",
                    Recommendation = "Consider changing one or more APs to a different channel to reduce interference."
                });
            }

            // Check for 2.4 GHz non-standard channels
            if (band == RadioBand.Band2_4GHz)
            {
                var nonStandardChannels = radiosInBand
                    .Where(r => r.Channel.HasValue && r.Channel.Value != 1 && r.Channel.Value != 6 && r.Channel.Value != 11)
                    .GroupBy(r => r.Channel!.Value)
                    .ToList();

                foreach (var group in nonStandardChannels)
                {
                    var apNames = _accessPoints
                        .Where(ap => ap.Radios.Any(r => r.Band == band && r.Channel == group.Key))
                        .Select(ap => ap.Name)
                        .ToList();

                    _channelIssues.Add(new ChannelIssue
                    {
                        Severity = "info",
                        Title = $"Non-Standard 2.4 GHz Channel {group.Key}",
                        Description = $"APs ({string.Join(", ", apNames)}) are using channel {group.Key}, which overlaps with adjacent channels.",
                        Recommendation = "For best performance, use only channels 1, 6, or 11 on 2.4 GHz to avoid overlap."
                    });
                }
            }

            // Check for high utilization
            var highUtilRadios = radiosInBand.Where(r => r.ChannelUtilization.HasValue && r.ChannelUtilization.Value > 70).ToList();
            foreach (var radio in highUtilRadios)
            {
                var ap = _accessPoints.FirstOrDefault(ap => ap.Radios.Contains(radio));
                if (ap != null)
                {
                    _channelIssues.Add(new ChannelIssue
                    {
                        Severity = "warning",
                        Title = $"High Channel Utilization on {ap.Name}",
                        Description = $"{band.ToDisplayString()} radio on channel {radio.Channel} has {radio.ChannelUtilization}% utilization.",
                        Recommendation = "Consider switching to a less congested channel or enabling DFS channels (5 GHz)."
                    });
                }
            }
        }
    }

    private void SelectChannel(RadioBand band, int channel)
    {
        var apsOnChannel = GetApsOnChannel(band, channel);
        if (apsOnChannel.Any())
        {
            _selectedChannel = _selectedChannel == channel ? null : channel;
        }
    }

    private List<int> GetChannelsForBand(RadioBand band)
    {
        return band switch
        {
            RadioBand.Band2_4GHz => Enumerable.Range(1, 11).ToList(),
            RadioBand.Band5GHz => new List<int> { 36, 40, 44, 48, 52, 56, 60, 64, 100, 104, 108, 112, 116, 120, 124, 128, 132, 136, 140, 144, 149, 153, 157, 161, 165 },
            RadioBand.Band6GHz => new List<int> { 1, 5, 9, 13, 17, 21, 25, 29, 33, 37, 41, 45, 49, 53, 57, 61, 65, 69, 73, 77, 81, 85, 89, 93 },
            _ => new List<int>()
        };
    }

    private List<AccessPointSnapshot> GetApsOnChannel(RadioBand band, int channel)
    {
        return _accessPoints
            .Where(ap => ap.Radios.Any(r => r.Band == band && r.Channel == channel))
            .ToList();
    }

    private int GetChannelUtilization(RadioBand band, int channel)
    {
        var radios = _accessPoints
            .SelectMany(ap => ap.Radios)
            .Where(r => r.Band == band && r.Channel == channel && r.ChannelUtilization.HasValue)
            .ToList();

        return radios.Count > 0 ? (int)radios.Average(r => r.ChannelUtilization!.Value) : 0;
    }

    private int GetChannelInterference(RadioBand band, int channel)
    {
        var radios = _accessPoints
            .SelectMany(ap => ap.Radios)
            .Where(r => r.Band == band && r.Channel == channel && r.Interference.HasValue)
            .ToList();

        return radios.Count > 0 ? (int)radios.Average(r => r.Interference!.Value) : 0;
    }

    private bool IsChannelOverlapped(RadioBand band, int? channel)
    {
        if (!channel.HasValue) return false;
        return GetApsOnChannel(band, channel.Value).Count > 1;
    }

    private (bool HasIssues, int ChannelCount) GetBandData(RadioBand band)
    {
        var radiosInBand = _accessPoints.SelectMany(ap => ap.Radios).Where(r => r.Band == band && r.Channel.HasValue).ToList();
        var channelGroups = radiosInBand.GroupBy(r => r.Channel!.Value).ToList();
        var hasOverlap = channelGroups.Any(g => g.Count() > 1);
        return (hasOverlap, channelGroups.Count);
    }

    private string GetBandDescription(RadioBand band)
    {
        return band switch
        {
            RadioBand.Band2_4GHz => "Channels 1-11 (20/40 MHz)",
            RadioBand.Band5GHz => "UNII-1, UNII-2, UNII-2e, UNII-3 (20-160 MHz)",
            RadioBand.Band6GHz => "Wi-Fi 6E channels (20-320 MHz)",
            _ => ""
        };
    }

    private string GetUtilizationStatClass(int util) => util switch
    {
        > 70 => "stat-danger",
        > 50 => "stat-warning",
        _ => ""
    };

    private string GetInterferenceStatClass(int interf) => interf switch
    {
        > 30 => "stat-danger",
        > 15 => "stat-warning",
        _ => ""
    };

    private string GetUtilizationClass(int util) => util switch
    {
        > 70 => "util-high",
        > 50 => "util-medium",
        _ => "util-low"
    };

    private string GetInterferenceClass(int interf) => interf switch
    {
        > 30 => "interf-high",
        > 15 => "interf-medium",
        _ => "interf-low"
    };

    private string GetSatisfactionClass(int sat) => sat switch
    {
        >= 80 => "sat-excellent",
        >= 60 => "sat-good",
        >= 40 => "sat-fair",
        _ => "sat-poor"
    };

    private class ChannelIssue
    {
        public string Severity { get; set; } = "info";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string? Recommendation { get; set; }
    }
}
