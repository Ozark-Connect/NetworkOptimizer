@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Web.Models
@using NetworkOptimizer.Web.Components.Shared
@using NetworkOptimizer.WiFi.Data
@inject FloorPlanService FloorPlanSvc
@inject ApMapService ApMapSvc
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="floor-plan-editor">
    <!-- Toolbar -->
    <div class="fp-toolbar">
        <div class="fp-toolbar-left">
            <select class="fp-select" value="@_selectedBuildingId" @onchange="OnBuildingChanged">
                <option value="0">Select Building...</option>
                @foreach (var b in _buildings)
                {
                    <option value="@b.Id">@b.Name</option>
                }
            </select>
            <button class="fp-btn fp-btn-sm" @onclick="ShowAddBuildingDialog" data-tooltip="Add new building">+</button>

            @if (_selectedBuilding != null)
            {
                <div class="fp-floor-picker">
                    @foreach (var f in _floors.OrderByDescending(f => f.FloorNumber))
                    {
                        <button class="fp-floor-btn @(f.Id == _selectedFloorId ? "active" : "")"
                                @onclick="() => SelectFloor(f.Id)"
                                data-tooltip="@f.Label">
                            @GetFloorLabel(f.FloorNumber)
                        </button>
                    }
                    <button class="fp-floor-btn fp-floor-add" @onclick="ShowAddFloorDialog" data-tooltip="Add floor">+</button>
                </div>
            }
            else if (AllFloorNumbers.Any())
            {
                <div class="fp-floor-picker">
                    @foreach (var fn in AllFloorNumbers)
                    {
                        <button class="fp-floor-btn @(fn == _globalActiveFloor ? "active" : "")"
                                @onclick="() => SetGlobalFloor(fn)"
                                data-tooltip="@GetFloorLabel(fn) Floor">
                            @GetFloorLabel(fn)
                        </button>
                    }
                </div>
            }
        </div>
        <div class="fp-toolbar-right">
            <button class="fp-btn @(_mode == "aps" ? "fp-btn-warning" : "")" @onclick="ToggleApEditMode">
                @(_mode == "aps" ? "Done" : "Edit APs")
            </button>
            @if (_selectedFloor != null)
            {
                <div class="fp-wall-group">
                    <button class="fp-btn @(_mode == "walls" ? "fp-btn-warning" : "")" @onclick="ToggleWallDrawMode">
                        @(_mode == "walls" ? "Done Drawing" : "Draw Walls")
                    </button>
                    @if (_mode == "walls")
                    {
                        <select class="fp-select fp-select-sm fp-wall-select" @bind="_wallMaterial">
                            @foreach (var mat in MaterialAttenuation.MaterialLabels
                                .Where(m => !m.Key.StartsWith("floor_")))
                            {
                                var db = MaterialAttenuation.GetAttenuation(mat.Key, "5");
                                <option value="@mat.Key">@mat.Value (@db dB)</option>
                            }
                        </select>
                    }
                    else
                    {
                        <button class="fp-btn fp-btn-danger-sm" @onclick="DeleteLastWall"
                                data-tooltip="Delete last wall">Undo Wall</button>
                    }
                </div>
                <button class="fp-btn @(_mode == "position" ? "active" : "")" @onclick="TogglePositionMode">
                    Position
                </button>
            }
            <button class="fp-btn @(_showHeatmap ? "active" : "")" @onclick="ToggleHeatmap">
                Heatmap
            </button>
            @if (_showHeatmap)
            {
                <select class="fp-select fp-select-sm" value="@_heatmapBand" @onchange="OnBandChanged">
                    <option value="2.4">2.4 GHz</option>
                    <option value="5">5 GHz</option>
                    <option value="6">6 GHz</option>
                </select>
            }
        </div>
    </div>

    <!-- Map -->
    <div class="fp-map-container" style="position: relative;">
        <div id="@_mapId" class="fp-map" style="height: @MapHeight;"></div>

        @if (_mode == "aps")
        {
            @if (UnplacedAps.Any())
            {
                <div class="fp-ap-panel">
                    <div class="fp-ap-panel-header">
                        @if (_selectedApForPlacement != null)
                        {
                            <span>Click the map to place <strong>@_selectedApForPlacement.Name</strong></span>
                        }
                        else
                        {
                            <span>Select an AP to place on the map</span>
                        }
                    </div>
                    <div class="fp-ap-panel-list">
                        @foreach (var ap in UnplacedAps)
                        {
                            <button class="fp-ap-item @(_selectedApForPlacement?.Mac == ap.Mac ? "selected" : "")"
                                    @onclick="() => SelectApForPlacement(ap)">
                                <img src="@(DeviceIcon.GetIconPath(ap.Model) ?? "/images/devices/default-ap.png")"
                                     alt="@ap.Model" class="fp-ap-item-icon" />
                                <span class="fp-ap-item-name">@ap.Name</span>
                            </button>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="fp-edit-hint">
                    Drag APs to adjust their locations
                </div>
            }
        }

        @if (_mode == "walls")
        {
            <div class="fp-edit-hint fp-wall-hint">
                Click to place vertices. First segment sets the angle, then snaps to 90° from it. Double-click to finish. Shift = free-form.
            </div>
        }

        @if (_showHeatmap)
        {
            <div class="fp-heatmap-legend">
                <div class="fp-legend-title">Signal (dBm)</div>
                <div class="fp-legend-bar"></div>
                <div class="fp-legend-labels">
                    <span>-30</span>
                    <span>-55</span>
                    <span>-65</span>
                    <span>-78</span>
                    <span>-85</span>
                </div>
            </div>
        }
    </div>

    <!-- Bottom bar -->
    @if (_selectedFloor != null)
    {
        <div class="fp-bottom-bar">
            <label class="fp-upload-btn">
                Upload Floor Plan
                <InputFile OnChange="OnFloorPlanUpload" accept="image/*" style="display:none" />
            </label>
            <div class="fp-opacity-control">
                <span>Opacity:</span>
                <input type="range" min="0" max="100" value="@((int)(_floorOpacity * 100))"
                       @oninput="OnOpacityChange" class="fp-opacity-slider" />
            </div>
            <button class="fp-btn fp-btn-danger" @onclick="DeleteSelectedFloor">Delete Floor</button>
        </div>
    }
</div>

<!-- Add Building Dialog -->
@if (_showAddBuilding)
{
    <div class="fp-dialog-backdrop" @onclick="() => _showAddBuilding = false">
        <div class="fp-dialog" @onclick:stopPropagation>
            <h3>Add Building</h3>
            <div class="fp-form-group">
                <label>Name</label>
                <input type="text" @bind="_newBuildingName" class="fp-input" placeholder="e.g. Main House" />
            </div>
            <div class="fp-dialog-actions">
                <button class="fp-btn" @onclick="() => _showAddBuilding = false">Cancel</button>
                <button class="fp-btn fp-btn-primary" @onclick="CreateBuilding">Create</button>
            </div>
        </div>
    </div>
}

<!-- Add Floor Dialog -->
@if (_showAddFloor)
{
    <div class="fp-dialog-backdrop" @onclick="() => _showAddFloor = false">
        <div class="fp-dialog" @onclick:stopPropagation>
            <h3>Add Floor</h3>
            <div class="fp-form-group">
                <label>Floor Number</label>
                <input type="number" @bind="_newFloorNumber" class="fp-input" />
            </div>
            <div class="fp-form-group">
                <label>Label</label>
                <input type="text" @bind="_newFloorLabel" class="fp-input" placeholder="e.g. Ground Floor" />
            </div>
            <div class="fp-dialog-actions">
                <button class="fp-btn" @onclick="() => _showAddFloor = false">Cancel</button>
                <button class="fp-btn fp-btn-primary" @onclick="CreateFloor">Create</button>
            </div>
        </div>
    </div>
}

<style>
    .floor-plan-editor {
        display: flex;
        flex-direction: column;
        gap: 0;
        background: var(--card-bg, #1a1a2e);
        border-radius: 8px;
        overflow: hidden;
    }

    .fp-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--card-header-bg, #16162a);
        border-bottom: 1px solid var(--border-color, #2d2d4a);
        flex-wrap: wrap;
        gap: 8px;
    }

    .fp-toolbar-left, .fp-toolbar-right {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
    }

    .fp-select {
        background: var(--input-bg, #0d0d1a);
        color: var(--text-color, #e0e0e0);
        border: 1px solid var(--border-color, #2d2d4a);
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 13px;
    }

    .fp-select-sm { max-width: 100px; }
    .fp-wall-select { max-width: 200px !important; }

    .fp-btn {
        background: var(--btn-bg, #2d2d4a);
        color: var(--text-color, #e0e0e0);
        border: 1px solid var(--border-color, #3d3d5c);
        border-radius: 4px;
        padding: 4px 10px;
        font-size: 13px;
        cursor: pointer;
        white-space: nowrap;
    }

    .fp-btn:hover { background: var(--btn-hover-bg, #3d3d5c); }
    .fp-btn.active { background: var(--accent-color, #4f46e5); border-color: var(--accent-color, #4f46e5); }
    .fp-btn-sm { padding: 2px 8px; }
    .fp-btn-primary { background: var(--accent-color, #4f46e5); border-color: var(--accent-color, #4f46e5); }
    .fp-btn-warning { background: rgba(234, 179, 8, 0.85); border-color: rgba(234, 179, 8, 0.85); color: #1e293b; font-weight: 600; }
    .fp-btn-warning:hover { background: rgba(234, 179, 8, 1); }
    .fp-btn-danger { background: #dc2626; border-color: #dc2626; }
    .fp-btn-danger:hover { background: #ef4444; }
    .fp-btn-danger-sm { background: transparent; border-color: #dc2626; color: #f87171; padding: 3px 8px; font-size: 12px; }
    .fp-btn-danger-sm:hover { background: #dc2626; color: #fff; }

    .fp-floor-picker { display: flex; gap: 2px; }

    .fp-floor-btn {
        background: var(--btn-bg, #2d2d4a);
        color: var(--text-color, #e0e0e0);
        border: 1px solid var(--border-color, #3d3d5c);
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 12px;
        cursor: pointer;
        min-width: 28px;
        text-align: center;
    }

    .fp-floor-btn.active { background: var(--accent-color, #4f46e5); border-color: var(--accent-color, #4f46e5); }
    .fp-floor-btn:hover { background: var(--btn-hover-bg, #3d3d5c); }
    .fp-floor-add { font-weight: bold; }

    .fp-wall-group { display: flex; align-items: center; gap: 4px; }

    .fp-map-container { position: relative; }

    .fp-map {
        width: 100%;
        min-height: 400px;
        background: #0d0d1a;
    }

    .fp-bottom-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: var(--card-header-bg, #16162a);
        border-top: 1px solid var(--border-color, #2d2d4a);
    }

    .fp-upload-btn {
        background: var(--btn-bg, #2d2d4a);
        color: var(--text-color, #e0e0e0);
        border: 1px solid var(--border-color, #3d3d5c);
        border-radius: 4px;
        padding: 4px 10px;
        font-size: 13px;
        cursor: pointer;
    }

    .fp-upload-btn:hover { background: var(--btn-hover-bg, #3d3d5c); }

    .fp-opacity-control {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-muted, #8888aa);
    }

    .fp-opacity-slider { width: 100px; accent-color: var(--accent-color, #4f46e5); }

    .fp-dialog-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .fp-dialog {
        background: var(--card-bg, #1a1a2e);
        border: 1px solid var(--border-color, #2d2d4a);
        border-radius: 8px;
        padding: 20px;
        min-width: 300px;
    }

    .fp-dialog h3 { margin: 0 0 16px; color: var(--text-color, #e0e0e0); font-size: 16px; }

    .fp-form-group { margin-bottom: 12px; }

    .fp-form-group label {
        display: block;
        font-size: 13px;
        color: var(--text-muted, #8888aa);
        margin-bottom: 4px;
    }

    .fp-input {
        width: 100%;
        background: var(--input-bg, #0d0d1a);
        color: var(--text-color, #e0e0e0);
        border: 1px solid var(--border-color, #2d2d4a);
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .fp-dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 16px;
    }

    /* AP placement panel */
    .fp-ap-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border-color, #2d2d4a);
        border-radius: 6px;
        padding: 0.75rem;
        max-width: 220px;
        max-height: 400px;
        overflow-y: auto;
    }

    .fp-ap-panel-header {
        font-size: 0.8rem;
        color: var(--text-muted, #8888aa);
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }

    .fp-ap-panel-list {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .fp-ap-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.5rem;
        background: var(--btn-bg, #2d2d4a);
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-color, #e0e0e0);
        font-size: 0.8rem;
        text-align: left;
        transition: all 0.15s ease;
    }

    .fp-ap-item:hover {
        background: var(--btn-hover-bg, #3d3d5c);
        border-color: var(--border-color, #2d2d4a);
    }

    .fp-ap-item.selected {
        background: rgba(59, 130, 246, 0.2);
        border-color: #3b82f6;
    }

    .fp-ap-item-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
    }

    .fp-ap-item-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Mode hints */
    .fp-edit-hint {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: rgba(234, 179, 8, 0.9);
        color: #1e293b;
        padding: 0.35rem 0.75rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        pointer-events: none;
        white-space: nowrap;
    }

    .fp-wall-hint { white-space: normal; max-width: 380px; text-align: center; }

    .fp-heatmap-legend {
        position: absolute;
        bottom: 30px;
        right: 10px;
        z-index: 1000;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(100, 116, 139, 0.4);
        border-radius: 6px;
        padding: 8px 10px;
        pointer-events: none;
    }

    .fp-legend-title {
        font-size: 11px;
        font-weight: 600;
        color: #94a3b8;
        margin-bottom: 4px;
        text-align: center;
    }

    .fp-legend-bar {
        width: 140px;
        height: 12px;
        border-radius: 2px;
        background: linear-gradient(to right, #00dc00, #22c55e, #b4dc28, #facc15, #fb923c, #ef4444, #6b7280);
    }

    .fp-legend-labels {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: #64748b;
        margin-top: 2px;
    }

    /* AP markers - match Coverage Map (no :global() - that only works in .razor.css files) */
    .fp-ap-marker-container {
        background: transparent !important;
        border: none !important;
    }

    .fp-ap-marker-icon {
        width: 32px;
        height: 32px;
        transform: scale(var(--fp-ap-scale, 1));
    }

    .fp-ap-glow-container {
        background: transparent !important;
        border: none !important;
    }

    .fp-ap-glow-dot {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.55) 0%, rgba(59, 130, 246, 0.12) 55%, transparent 100%);
        filter: blur(3px);
        transform: scale(var(--fp-ap-scale, 1));
    }

    .fp-ap-glow-dot.other-floor {
        background: radial-gradient(circle, rgba(100, 100, 140, 0.3) 0%, transparent 55%);
    }

    /* AP direction indicator */
    .fp-ap-direction {
        position: absolute;
        width: 32px;
        height: 32px;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 1;
    }

    .fp-ap-arrow {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-bottom: 10px solid #60a5fa;
        filter: drop-shadow(0 0 2px rgba(96, 165, 250, 0.8));
    }

    /* Wall length labels */
    .fp-wall-length {
        font-size: 11px;
        font-weight: 700;
        color: #1e293b;
        background: rgba(255, 255, 255, 0.92) !important;
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid rgba(0, 0, 0, 0.25) !important;
        white-space: nowrap;
        text-align: center;
        pointer-events: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* Wall vertex dots during drawing */
    .fp-wall-vertex {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
    }

    /* Floor plan corner handles */
    .fp-corner-handle {
        width: 14px;
        height: 14px;
        background: #4f46e5;
        border: 2px solid #fff;
        border-radius: 3px;
        cursor: move;
    }

    /* Contour line labels */
    .fp-contour-label {
        font-size: 10px;
        font-weight: 700;
        color: #fff;
        background: rgba(0, 0, 0, 0.6) !important;
        padding: 1px 4px;
        border-radius: 2px;
        white-space: nowrap;
        text-align: center;
        pointer-events: none;
        border: none !important;
    }

    /* Close-shape snap indicator */
    .fp-snap-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid #60a5fa;
        background: rgba(96, 165, 250, 0.25);
        animation: fp-snap-pulse 0.8s ease-in-out infinite;
    }

    @@keyframes fp-snap-pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.4); opacity: 0.6; }
    }

    @@media (max-width: 768px) {
        .fp-toolbar { flex-direction: column; align-items: flex-start; }
        .fp-toolbar-left, .fp-toolbar-right { width: 100%; }
    }
</style>

@code {
    [Parameter] public string MapHeight { get; set; } = "600px";

    private string _mapId = "fp-map-" + Guid.NewGuid().ToString("N");
    private DotNetObjectReference<FloorPlanEditor>? _dotNetRef;
    private bool _mapInitialized;

    private List<BuildingDto> _buildings = new();
    private List<FloorDto> _floors = new();
    private List<ApMapMarker> _apMarkers = new();
    private int _selectedBuildingId;
    private int _selectedFloorId;
    private BuildingDto? _selectedBuilding;
    private FloorDto? _selectedFloor;

    private string _mode = "view";
    private bool _showHeatmap = true;
    private int _globalActiveFloor = 1;
    private string _heatmapBand = "5";
    private string _wallMaterial = "drywall";
    private double _floorOpacity = 0.7;
    private bool _showAddBuilding;
    private bool _showAddFloor;
    private string _newBuildingName = "";
    private int _newFloorNumber;
    private string _newFloorLabel = "";
    private ApMapMarker? _selectedApForPlacement;

    private IEnumerable<ApMapMarker> UnplacedAps => _apMarkers.Where(a => !a.Latitude.HasValue || !a.Longitude.HasValue);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await LoadBuildings();
            await LoadApMarkers();
            await InitializeMap();
            // Show placed APs immediately on map load (no floor selection needed)
            await UpdateApMarkers();
            if (_showHeatmap) await ComputeHeatmap();
            StateHasChanged();
        }
    }

    private async Task InitializeMap()
    {
        var centerLat = 38.0;
        var centerLng = -92.0;
        var zoom = 4;
        var firstAp = _apMarkers.FirstOrDefault(a => a.Latitude.HasValue);
        if (firstAp != null)
        {
            centerLat = firstAp.Latitude!.Value;
            centerLng = firstAp.Longitude!.Value;
            zoom = 19;
        }

        await JS.InvokeVoidAsync("fpEditor.initMap", _mapId, centerLat, centerLng, zoom);
        await JS.InvokeVoidAsync("fpEditor.setDotNetRef", _dotNetRef);
        _mapInitialized = true;
    }

    private async Task LoadBuildings()
    {
        try
        {
            var buildings = await FloorPlanSvc.GetBuildingsAsync();
            _buildings = buildings.Select(b => new BuildingDto
            {
                Id = b.Id, Name = b.Name,
                CenterLatitude = b.CenterLatitude, CenterLongitude = b.CenterLongitude,
                Floors = b.Floors.Select(f => new FloorDto
                {
                    Id = f.Id, BuildingId = f.BuildingId, FloorNumber = f.FloorNumber, Label = f.Label,
                    SwLatitude = f.SwLatitude, SwLongitude = f.SwLongitude,
                    NeLatitude = f.NeLatitude, NeLongitude = f.NeLongitude,
                    Opacity = f.Opacity, WallsJson = f.WallsJson,
                    HasImage = !string.IsNullOrEmpty(f.ImagePath)
                }).ToList()
            }).ToList();
        }
        catch { }
    }

    private async Task LoadApMarkers()
    {
        try { _apMarkers = await ApMapSvc.GetApMapMarkersAsync(); }
        catch { }
    }

    // ── Building / Floor management ──────────────────────────────────

    private async Task OnBuildingChanged(ChangeEventArgs e)
    {
        _selectedBuildingId = int.TryParse(e.Value?.ToString(), out var id) ? id : 0;
        _selectedBuilding = _buildings.FirstOrDefault(b => b.Id == _selectedBuildingId);
        _floors = _selectedBuilding?.Floors ?? new();
        _selectedFloorId = 0;
        _selectedFloor = null;

        if (_selectedBuilding != null && _floors.Count > 0)
        {
            await SelectFloor(_floors.First().Id);
            // Fit map to building's combined floor bounds
            var swLat = _floors.Min(f => f.SwLatitude);
            var swLng = _floors.Min(f => f.SwLongitude);
            var neLat = _floors.Max(f => f.NeLatitude);
            var neLng = _floors.Max(f => f.NeLongitude);
            await JS.InvokeVoidAsync("fpEditor.fitBounds", swLat, swLng, neLat, neLng);
        }
        else if (_selectedBuilding != null)
            await JS.InvokeVoidAsync("fpEditor.setView",
                _selectedBuilding.CenterLatitude, _selectedBuilding.CenterLongitude, 19);

        await UpdateApMarkers();
        StateHasChanged();
    }

    private async Task SelectFloor(int floorId)
    {
        _selectedFloorId = floorId;
        _selectedFloor = _floors.FirstOrDefault(f => f.Id == floorId);
        if (_selectedFloor != null)
        {
            _globalActiveFloor = _selectedFloor.FloorNumber;
            _floorOpacity = _selectedFloor.Opacity;
            await UpdateFloorOverlay();
            await UpdateApMarkers();
            await UpdateWalls();
            if (_showHeatmap) await ComputeHeatmap();
        }
        StateHasChanged();
    }

    // ── Floor plan overlay ───────────────────────────────────────────

    private async Task UpdateFloorOverlay()
    {
        if (_selectedFloor == null || !_mapInitialized) return;
        var baseUrl = Nav.BaseUri.TrimEnd('/');
        var imageUrl = _selectedFloor.HasImage ? baseUrl + "/api/floors/" + _selectedFloor.Id + "/image" : "";
        await JS.InvokeVoidAsync("fpEditor.updateFloorOverlay", imageUrl,
            _selectedFloor.SwLatitude, _selectedFloor.SwLongitude,
            _selectedFloor.NeLatitude, _selectedFloor.NeLongitude, _floorOpacity);
    }

    // ── AP markers (match Coverage Map) ──────────────────────────────

    private async Task UpdateApMarkers()
    {
        if (!_mapInitialized) return;

        var placedAps = _apMarkers
            .Where(a => a.Latitude.HasValue && a.Longitude.HasValue);

        var markersJson = System.Text.Json.JsonSerializer.Serialize(placedAps.Select(a => new
        {
            mac = a.Mac, name = a.Name, model = a.Model,
            lat = a.Latitude, lng = a.Longitude, floor = a.Floor ?? 1,
            orientation = a.OrientationDeg, mountType = a.MountType,
            online = a.IsOnline, clients = a.TotalClients,
            iconUrl = DeviceIcon.GetIconPath(a.Model) ?? "/images/devices/default-ap.png",
            sameFloor = (a.Floor ?? 1) == _globalActiveFloor
        }));

        await JS.InvokeVoidAsync("fpEditor.updateApMarkers", markersJson, _mode == "aps");
    }

    [JSInvokable]
    public async Task OnApDragEndFromJs(string mac, double lat, double lng)
    {
        await ApMapSvc.SaveApLocationAsync(mac, lat, lng);
        await LoadApMarkers();
        await UpdateApMarkers();
        if (_showHeatmap) await ComputeHeatmap();
    }

    [JSInvokable]
    public async Task OnApFloorChangedFromJs(string mac, int floor)
    {
        await ApMapSvc.SaveApFloorAsync(mac, floor);
        await LoadApMarkers();
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            await UpdateApMarkers();
            if (_showHeatmap) await ComputeHeatmap();
        });
    }

    [JSInvokable]
    public async Task OnApOrientationChangedFromJs(string mac, int orientationDeg)
    {
        await ApMapSvc.SaveApOrientationAsync(mac, orientationDeg);
        await LoadApMarkers();
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            await UpdateApMarkers();
            if (_showHeatmap) await ComputeHeatmap();
        });
    }

    [JSInvokable]
    public async Task OnApMountTypeChangedFromJs(string mac, string mountType)
    {
        await ApMapSvc.SaveApMountTypeAsync(mac, mountType);
        await LoadApMarkers();
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            await UpdateApMarkers();
            if (_showHeatmap) await ComputeHeatmap();
        });
    }

    private async Task ToggleApEditMode()
    {
        _mode = _mode == "aps" ? "view" : "aps";
        _selectedApForPlacement = null;
        await UpdateApMarkers();
        await SetMapClickToPlaceMode(_mode == "aps");
    }

    private void SelectApForPlacement(ApMapMarker ap)
    {
        _selectedApForPlacement = _selectedApForPlacement?.Mac == ap.Mac ? null : ap;
    }

    private async Task SetMapClickToPlaceMode(bool enabled)
    {
        if (!_mapInitialized) return;
        await JS.InvokeVoidAsync("fpEditor.setPlacementMode", enabled);
    }

    [JSInvokable]
    public async Task OnMapClickForPlacement(double lat, double lng)
    {
        if (_selectedApForPlacement == null) return;
        var mac = _selectedApForPlacement.Mac;
        _selectedApForPlacement = null;

        await ApMapSvc.SaveApLocationAsync(mac, lat, lng);
        await LoadApMarkers();
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            if (_mapInitialized)
                await UpdateApMarkers();
        });
    }

    // ── Wall drawing system ──────────────────────────────────────────

    private async Task UpdateWalls()
    {
        if (!_mapInitialized || _selectedFloor == null) return;
        var wallsJson = _selectedFloor.WallsJson ?? "[]";
        var colorsJson = System.Text.Json.JsonSerializer.Serialize(MaterialAttenuation.MaterialColors);
        var labelsJson = System.Text.Json.JsonSerializer.Serialize(
            MaterialAttenuation.MaterialLabels
                .Where(m => !m.Key.StartsWith("floor_"))
                .ToDictionary(m => m.Key, m => m.Value));
        await JS.InvokeVoidAsync("fpEditor.updateWalls", wallsJson, colorsJson, labelsJson);
    }

    private async Task ToggleWallDrawMode()
    {
        _mode = _mode == "walls" ? "view" : "walls";
        if (_mode == "walls")
            await SetMapClickToPlaceMode(false);

        if (_mode == "walls")
        {
            var initWalls = _selectedFloor?.WallsJson ?? "[]";
            await JS.InvokeVoidAsync("fpEditor.enterDrawMode", initWalls);
        }
        else
        {
            await JS.InvokeVoidAsync("fpEditor.exitDrawMode");
            // Re-render walls from DB state after exiting draw mode
            if (_selectedFloor != null) await UpdateWalls();
        }
        await UpdateApMarkers();
    }

    [JSInvokable]
    public async Task OnMapClickForWall(double lat, double lng)
    {
        if (_mode != "walls") return;
        var color = MaterialAttenuation.MaterialColors.GetValueOrDefault(_wallMaterial, "#94a3b8");
        await JS.InvokeVoidAsync("fpEditor.addWallPoint", lat, lng, _wallMaterial, color);
    }

    [JSInvokable]
    public async Task OnMapDblClickFinishWall()
    {
        if (_mode != "walls" || _selectedFloor == null) return;
        await JS.InvokeVoidAsync("fpEditor.finishWall");
    }

    [JSInvokable]
    public async Task SaveWallsFromJs(string wallsJson)
    {
        if (_selectedFloor == null) return;
        _selectedFloor.WallsJson = wallsJson;
        await FloorPlanSvc.UpdateFloorAsync(_selectedFloor.Id, wallsJson: wallsJson);
        // Re-render walls from saved state so they persist visually
        await UpdateWalls();
        if (_showHeatmap) await ComputeHeatmap();
    }

    private async Task DeleteLastWall()
    {
        if (_selectedFloor == null) return;
        await JS.InvokeVoidAsync("fpEditor.deleteLastWall");
    }

    // ── Floor plan positioning ───────────────────────────────────────

    private async Task TogglePositionMode()
    {
        _mode = _mode == "position" ? "view" : "position";
        if (_mode == "position" && _selectedFloor != null)
            await JS.InvokeVoidAsync("fpEditor.enterPositionMode");
        else
            await JS.InvokeVoidAsync("fpEditor.exitPositionMode");
    }

    [JSInvokable]
    public async Task OnBoundsChangedFromJs(double swLat, double swLng, double neLat, double neLng)
    {
        if (_selectedFloor == null) return;
        _selectedFloor.SwLatitude = swLat;
        _selectedFloor.SwLongitude = swLng;
        _selectedFloor.NeLatitude = neLat;
        _selectedFloor.NeLongitude = neLng;
        await FloorPlanSvc.UpdateFloorAsync(_selectedFloor.Id, swLat, swLng, neLat, neLng);
    }

    // ── Heatmap ──────────────────────────────────────────────────────

    private async Task ToggleHeatmap()
    {
        _showHeatmap = !_showHeatmap;
        if (_showHeatmap)
            await ComputeHeatmap();
        else
            await JS.InvokeVoidAsync("fpEditor.clearHeatmap");
    }

    private async Task OnBandChanged(ChangeEventArgs e)
    {
        _heatmapBand = e.Value?.ToString() ?? "5";
        if (_showHeatmap) await ComputeHeatmap();
    }

    private async Task ComputeHeatmap()
    {
        if (!_mapInitialized) return;
        var baseUrl = Nav.BaseUri.TrimEnd('/');
        await JS.InvokeVoidAsync("fpEditor.computeHeatmap", baseUrl, _globalActiveFloor, _heatmapBand);
    }

    // ── Floor plan management ────────────────────────────────────────

    private async Task OnOpacityChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var pct))
        {
            _floorOpacity = pct / 100.0;
            if (_selectedFloor != null)
            {
                _selectedFloor.Opacity = _floorOpacity;
                await FloorPlanSvc.UpdateFloorAsync(_selectedFloor.Id, opacity: _floorOpacity);
                await JS.InvokeVoidAsync("fpEditor.setFloorOpacity", _floorOpacity);
            }
        }
    }

    private async Task OnFloorPlanUpload(InputFileChangeEventArgs e)
    {
        if (_selectedFloor == null) return;
        var file = e.File;
        if (file.Size > 20 * 1024 * 1024) return;

        using var stream = file.OpenReadStream(20 * 1024 * 1024);
        await FloorPlanSvc.SaveFloorImageAsync(_selectedFloor.Id, stream);
        _selectedFloor.HasImage = true;

        if (_selectedFloor.SwLatitude == 0 && _selectedFloor.NeLatitude == 0 && _selectedBuilding != null)
        {
            var centerLat = _selectedBuilding.CenterLatitude;
            var centerLng = _selectedBuilding.CenterLongitude;
            if (centerLat == 0 && centerLng == 0) { centerLat = 38.0; centerLng = -92.0; }
            var latOffset = 25.0 / 111320.0;
            var lngOffset = 25.0 / (111320.0 * Math.Cos(centerLat * Math.PI / 180));
            _selectedFloor.SwLatitude = centerLat - latOffset;
            _selectedFloor.SwLongitude = centerLng - lngOffset;
            _selectedFloor.NeLatitude = centerLat + latOffset;
            _selectedFloor.NeLongitude = centerLng + lngOffset;
            await FloorPlanSvc.UpdateFloorAsync(_selectedFloor.Id,
                _selectedFloor.SwLatitude, _selectedFloor.SwLongitude,
                _selectedFloor.NeLatitude, _selectedFloor.NeLongitude);
        }

        await UpdateFloorOverlay();
        StateHasChanged();
    }

    private void ShowAddBuildingDialog()
    {
        _newBuildingName = "";
        _showAddBuilding = true;
    }

    private async Task CreateBuilding()
    {
        if (string.IsNullOrWhiteSpace(_newBuildingName)) return;
        var lat = 38.0;
        var lng = -92.0;
        var firstAp = _apMarkers.FirstOrDefault(a => a.Latitude.HasValue);
        if (firstAp != null) { lat = firstAp.Latitude!.Value; lng = firstAp.Longitude!.Value; }

        var building = await FloorPlanSvc.CreateBuildingAsync(_newBuildingName, lat, lng);
        _showAddBuilding = false;
        await LoadBuildings();
        _selectedBuildingId = building.Id;
        _selectedBuilding = _buildings.FirstOrDefault(b => b.Id == building.Id);
        _floors = _selectedBuilding?.Floors ?? new();
        StateHasChanged();
    }

    private void ShowAddFloorDialog()
    {
        var maxFloor = _floors.Count > 0 ? _floors.Max(f => f.FloorNumber) : -1;
        _newFloorNumber = maxFloor + 1;
        _newFloorLabel = GetDefaultFloorLabel(_newFloorNumber);
        _showAddFloor = true;
    }

    private static string GetDefaultFloorLabel(int n)
    {
        if (n <= -1) return "Basement " + Math.Abs(n);
        if (n == 0) return "Ground Floor";
        if (n == 1) return "1st Floor";
        if (n == 2) return "2nd Floor";
        if (n == 3) return "3rd Floor";
        return n + "th Floor";
    }

    private async Task CreateFloor()
    {
        if (_selectedBuilding == null) return;
        var lat = _selectedBuilding.CenterLatitude;
        var lng = _selectedBuilding.CenterLongitude;
        var cosLat = lat == 0 ? 1.0 : Math.Cos(lat * Math.PI / 180);
        var latOffset = 25.0 / 111320.0;
        var lngOffset = 25.0 / (111320.0 * cosLat);

        await FloorPlanSvc.CreateFloorAsync(_selectedBuilding.Id, _newFloorNumber, _newFloorLabel,
            lat - latOffset, lng - lngOffset, lat + latOffset, lng + lngOffset);

        _showAddFloor = false;
        await LoadBuildings();
        _selectedBuilding = _buildings.FirstOrDefault(b => b.Id == _selectedBuildingId);
        _floors = _selectedBuilding?.Floors ?? new();
        var newFloor = _floors.FirstOrDefault(f => f.FloorNumber == _newFloorNumber);
        if (newFloor != null) await SelectFloor(newFloor.Id);
        StateHasChanged();
    }

    private async Task DeleteSelectedFloor()
    {
        if (_selectedFloor == null) return;
        await FloorPlanSvc.DeleteFloorAsync(_selectedFloor.Id);
        await LoadBuildings();
        _selectedBuilding = _buildings.FirstOrDefault(b => b.Id == _selectedBuildingId);
        _floors = _selectedBuilding?.Floors ?? new();
        _selectedFloorId = 0;
        _selectedFloor = null;

        await JS.InvokeVoidAsync("fpEditor.clearFloorLayers");
        StateHasChanged();
    }

    // ── Global floor picker ────────────────────────────────────────

    private IEnumerable<int> AllFloorNumbers => _buildings
        .SelectMany(b => b.Floors)
        .Select(f => f.FloorNumber)
        .Distinct()
        .OrderByDescending(n => n);

    private async Task SetGlobalFloor(int floorNumber)
    {
        _globalActiveFloor = floorNumber;
        await UpdateApMarkers();
        if (_showHeatmap) await ComputeHeatmap();
        StateHasChanged();
    }

    // ── Helpers ──────────────────────────────────────────────────────

    private static string GetFloorLabel(int floorNumber)
    {
        if (floorNumber <= -1) return "B" + Math.Abs(floorNumber);
        var lastTwo = Math.Abs(floorNumber) % 100;
        var suffix = (lastTwo >= 11 && lastTwo <= 13) ? "th" : (Math.Abs(floorNumber) % 10) switch
        {
            1 => "st",
            2 => "nd",
            3 => "rd",
            _ => "th"
        };
        return floorNumber + suffix;
    }

    [JSInvokable]
    public async Task OnMapMoveEndForHeatmap()
    {
        if (_showHeatmap)
            await ComputeHeatmap();
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }

    private class BuildingDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public double CenterLatitude { get; set; }
        public double CenterLongitude { get; set; }
        public List<FloorDto> Floors { get; set; } = new();
    }

    private class FloorDto
    {
        public int Id { get; set; }
        public int BuildingId { get; set; }
        public int FloorNumber { get; set; }
        public string Label { get; set; } = "";
        public double SwLatitude { get; set; }
        public double SwLongitude { get; set; }
        public double NeLatitude { get; set; }
        public double NeLongitude { get; set; }
        public double Opacity { get; set; } = 0.7;
        public string? WallsJson { get; set; }
        public bool HasImage { get; set; }
    }
}
