@using System.Reflection
@inject IJSRuntime JS

@if (updateAvailable && !string.IsNullOrEmpty(latestVersion))
{
    <div class="connection-banner" style="background: linear-gradient(135deg, #12261d 0%, #0c1a14 100%); border-color: #1e3d2e;">
        <div class="banner-content">
            <span class="banner-icon" style="background: #24bc70; color: white;">â¬†</span>
            <div class="banner-text">
                <strong style="color: #4ade80;">Update Available: v@(latestVersion)</strong>
                <span style="color: #86b89a;">A new version of Network Optimizer is available.</span>
            </div>
            <a href="https://github.com/Ozark-Connect/NetworkOptimizer/blob/main/docker/DEPLOYMENT.md#upgrade-procedure" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light">Upgrade Guide</a>
            <a href="@releaseUrl" target="_blank" rel="noopener noreferrer" class="btn btn-success">View Release</a>
        </div>
    </div>
}

@code {
    private bool updateAvailable = false;
    private string? latestVersion;
    private string? releaseUrl;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckForUpdateAsync();
        }
    }

    private async Task CheckForUpdateAsync()
    {
        try
        {
            var currentVersion = Assembly.GetExecutingAssembly()
                .GetCustomAttribute<AssemblyInformationalVersionAttribute>()
                ?.InformationalVersion ?? "0.0.0";

            var result = await JS.InvokeAsync<UpdateCheckResult?>("updateChecker.checkForUpdate", currentVersion);

            if (result?.UpdateAvailable == true)
            {
                updateAvailable = true;
                latestVersion = result.LatestVersion;
                releaseUrl = result.ReleaseUrl ?? "https://github.com/Ozark-Connect/NetworkOptimizer/releases/latest";
                StateHasChanged();
            }
        }
        catch
        {
            // Silently fail - update check is non-critical
        }
    }

    private class UpdateCheckResult
    {
        public bool UpdateAvailable { get; set; }
        public string? LatestVersion { get; set; }
        public string? ReleaseUrl { get; set; }
    }
}
