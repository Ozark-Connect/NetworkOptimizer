@page "/diagnostics"
@using NetworkOptimizer.Diagnostics
@using NetworkOptimizer.Diagnostics.Models
@using NetworkOptimizer.Core.Enums
@inject DiagnosticsService DiagnosticsService
@inject UniFiConnectionService ConnectionService
@inject ILogger<Diagnostics> Logger
@rendermode InteractiveServer

<PageTitle>Diagnostics - Network Optimizer</PageTitle>

<div class="page-header">
    <h1>Network Diagnostics</h1>
    <p class="page-description">Analyze network configuration for potential issues</p>
</div>

@if (!ConnectionService.IsConnected && ConnectionService.IsInitialized)
{
    <div class="connection-banner">
        <div class="banner-content">
            <span class="banner-icon">!</span>
            <div class="banner-text">
                <strong>Not Connected</strong>
                <span>Connect to your UniFi Console to run diagnostics.</span>
            </div>
            <a href="/settings" class="btn btn-primary">Connect Now</a>
        </div>
    </div>
}

<div class="diagnostics-container">
    <!-- Diagnostics Controls -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Diagnostics Controls</h2>
        </div>
        <div class="card-body">
            <div class="diagnostics-controls">
                <button class="btn btn-primary" @onclick="RunDiagnostics" disabled="@(_isRunning || !ConnectionService.IsConnected)" style="min-width: 160px;">
                    @if (_isRunning)
                    {
                        <span class="spinner"></span>
                        <span>Running...</span>
                    }
                    else
                    {
                        <span>Run Diagnostics</span>
                    }
                </button>

                <div class="diagnostics-options">
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="_runApLockAnalyzer" />
                        <span>AP Lock Detection</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="_runTrunkConsistency" />
                        <span>Trunk VLAN Consistency</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="_runPortProfileSuggestions" />
                        <span>Port Profile Suggestions</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnostics Results Summary -->
    @if (_result != null)
    {
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Diagnostics Summary</h2>
                <span class="audit-timestamp"><span class="timestamp-label">Last run: </span>@_result.Timestamp.ToLocalTime().ToString("g")</span>
            </div>
            <div class="card-body">
                <div class="diagnostics-summary">
                    <div class="summary-stats">
                        <div class="stat-item @(_result.WarningCount > 0 ? "has-warnings" : "")">
                            <span class="stat-value">@_result.WarningCount</span>
                            <span class="stat-label">Recommendations</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">@_result.TotalIssueCount</span>
                            <span class="stat-label">Total Issues</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AP Lock Issues -->
        @if (_result.ApLockIssues.Count > 0)
        {
            <div class="card">
                <div class="card-header card-header-collapsible" @onclick="ToggleApLockSection">
                    <div class="card-header-left">
                        <span class="collapse-chevron @(_apLockCollapsed ? "" : "expanded")">@((MarkupString)ChevronIcon)</span>
                        <h2 class="card-title">AP Lock Issues</h2>
                    </div>
                    <span class="issue-count-badge">@_result.ApLockIssues.Count</span>
                </div>
                @if (!_apLockCollapsed)
                {
                    <div class="card-body">
                        <div class="issues-list">
                            @foreach (var issue in GetSortedApLockIssues())
                            {
                                <div class="issue-item issue-@GetSeverityCssClass(issue.Severity)">
                                    <div class="issue-icon">
                                        @((MarkupString)GetSeverityIcon(issue.Severity))
                                    </div>
                                    <div class="issue-body">
                                        <div class="issue-header">
                                            <span class="issue-severity">@GetSeverityDisplayName(issue.Severity)</span>
                                        </div>
                                        <div class="issue-title">
                                            @issue.ClientName
                                            @if (issue.IsOffline)
                                            {
                                                <span class="offline-badge">Offline</span>
                                            }
                                        </div>
                                        <div class="issue-context">
                                            <span class="context-item"><strong>Locked to:</strong> @issue.LockedApName</span>
                                            <span class="context-item"><strong>Type:</strong> @issue.DeviceDetection.Category.GetDisplayName()</span>
                                            @if (issue.RoamCount.HasValue)
                                            {
                                                <span class="context-item"><strong>Roams:</strong> @issue.RoamCount</span>
                                            }
                                            @if (issue.IsOffline && issue.LastSeen.HasValue)
                                            {
                                                <span class="context-item"><strong>Last seen:</strong> @FormatLastSeen(issue.LastSeen.Value)</span>
                                            }
                                        </div>
                                        <div class="issue-recommendation">
                                            <strong>Recommendation:</strong> @issue.Recommendation
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Trunk Consistency Issues -->
        @if (_result.TrunkConsistencyIssues.Count > 0)
        {
            <div class="card">
                <div class="card-header card-header-collapsible" @onclick="ToggleTrunkSection">
                    <div class="card-header-left">
                        <span class="collapse-chevron @(_trunkCollapsed ? "" : "expanded")">@((MarkupString)ChevronIcon)</span>
                        <h2 class="card-title">Trunk VLAN Consistency</h2>
                    </div>
                    <span class="issue-count-badge">@_result.TrunkConsistencyIssues.Count</span>
                </div>
                @if (!_trunkCollapsed)
                {
                    <div class="card-body">
                        <div class="issues-list">
                            @foreach (var issue in _result.TrunkConsistencyIssues.OrderBy(i => GetConfidenceOrder(i.Confidence)))
                            {
                                <div class="issue-item issue-@GetConfidenceCssClass(issue.Confidence)">
                                    <div class="issue-icon">
                                        @((MarkupString)GetConfidenceIcon(issue.Confidence))
                                    </div>
                                    <div class="issue-body">
                                        <div class="issue-header">
                                            <span class="issue-severity">@issue.Confidence Confidence</span>
                                        </div>
                                        <div class="issue-title">@issue.Link.DeviceAName ↔ @issue.Link.DeviceBName</div>
                                        <div class="issue-context">
                                            <span class="context-item"><strong>Link:</strong> Port @issue.Link.DeviceAPort ↔ Port @issue.Link.DeviceBPort</span>
                                            <span class="context-item"><strong>Missing VLANs:</strong> @string.Join(", ", issue.Mismatches.Select(m => $"{m.NetworkName} ({m.VlanId})"))</span>
                                        </div>
                                        <div class="issue-recommendation">
                                            <strong>Recommendation:</strong> @issue.Recommendation
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Port Profile Suggestions -->
        @if (_result.PortProfileSuggestions.Count > 0)
        {
            <div class="card">
                <div class="card-header card-header-collapsible" @onclick="TogglePortProfileSection">
                    <div class="card-header-left">
                        <span class="collapse-chevron @(_portProfileCollapsed ? "" : "expanded")">@((MarkupString)ChevronIcon)</span>
                        <h2 class="card-title">Port Profile Suggestions</h2>
                    </div>
                    <span class="issue-count-badge">@_result.PortProfileSuggestions.Count</span>
                </div>
                @if (!_portProfileCollapsed)
                {
                    <div class="card-body">
                        <div class="issues-list">
                            @foreach (var suggestion in _result.PortProfileSuggestions)
                            {
                                <div class="issue-item issue-info">
                                    <div class="issue-icon">
                                        @((MarkupString)InfoIcon)
                                    </div>
                                    <div class="issue-body">
                                        <div class="issue-header">
                                            <span class="issue-severity">@GetSuggestionTypeDisplay(suggestion.Type)</span>
                                        </div>
                                        <div class="issue-title">@(suggestion.MatchingProfileName ?? suggestion.SuggestedProfileName)</div>
                                        <div class="issue-context">
                                            <span class="context-item"><strong>Ports:</strong> @suggestion.AffectedPorts.Count affected</span>
                                            <span class="context-item"><strong>Without Profile:</strong> @suggestion.PortsWithoutProfile</span>
                                            @if (suggestion.Configuration.AllowedVlanNames.Count > 0)
                                            {
                                                <span class="context-item"><strong>VLANs:</strong> @string.Join(", ", suggestion.Configuration.AllowedVlanNames.Take(5))@(suggestion.Configuration.AllowedVlanNames.Count > 5 ? $" +{suggestion.Configuration.AllowedVlanNames.Count - 5} more" : "")</span>
                                            }
                                        </div>
                                        <div class="issue-recommendation">
                                            <strong>Recommendation:</strong> @suggestion.Recommendation
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }

        <!-- No Issues Found -->
        @if (_result.TotalIssueCount == 0)
        {
            <div class="card">
                <div class="card-body text-center">
                    <div class="empty-state">
                        <div class="empty-icon-img"><img src="/icons/check-circle.png" alt="" onerror="this.style.display='none'" /></div>
                        <div class="no-issues-icon">@((MarkupString)SuccessIcon)</div>
                        <h3>No Issues Found</h3>
                        <p>Your network configuration looks good!</p>
                    </div>
                </div>
            </div>
        }
    }
    else if (!_isRunning)
    {
        <div class="card">
            <div class="card-body text-center">
                <div class="empty-state">
                    <div class="empty-icon-img"><img src="/icons/warning-v2.png" alt="" /></div>
                    <h3>No Diagnostics Results</h3>
                    <p>Run diagnostics to analyze your network configuration.</p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DiagnosticsResult? _result;
    private bool _isRunning;
    private bool _runApLockAnalyzer = true;
    private bool _runTrunkConsistency = true;
    private bool _runPortProfileSuggestions = true;

    // Collapsible section state
    private bool _apLockCollapsed;
    private bool _trunkCollapsed;
    private bool _portProfileCollapsed;

    // SVG Icons matching the Audit page style
    private const string WarningIcon = """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M1 21h22L12 2 1 21z" opacity="0.2"/><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"/></svg>""";
    private const string InfoIcon = """<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><circle cx="12" cy="12" r="10" opacity="0.2"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><rect x="11" y="11" width="2" height="6"/><rect x="11" y="7" width="2" height="2"/></svg>""";
    private const string SuccessIcon = """<svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48"><circle cx="12" cy="12" r="10" opacity="0.2" fill="var(--success-color)"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" fill="var(--success-color)"/><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z" fill="var(--success-color)"/></svg>""";
    private const string ChevronIcon = """<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>""";

    protected override void OnInitialized()
    {
        _result = DiagnosticsService.LastResult;
        InitializeCollapsedState();
    }

    private void InitializeCollapsedState()
    {
        if (_result == null) return;

        // Default collapsed if > 3 issues
        _apLockCollapsed = _result.ApLockIssues.Count > 3;
        _trunkCollapsed = _result.TrunkConsistencyIssues.Count > 3;
        _portProfileCollapsed = _result.PortProfileSuggestions.Count > 3;
    }

    private void ToggleApLockSection() => _apLockCollapsed = !_apLockCollapsed;
    private void ToggleTrunkSection() => _trunkCollapsed = !_trunkCollapsed;
    private void TogglePortProfileSection() => _portProfileCollapsed = !_portProfileCollapsed;

    private IEnumerable<ApLockIssue> GetSortedApLockIssues()
    {
        if (_result == null) return Enumerable.Empty<ApLockIssue>();

        return _result.ApLockIssues
            .OrderBy(i => GetSeverityOrder(i.Severity))
            .ThenBy(i => i.IsOffline)
            .ThenBy(i => i.ClientName, StringComparer.OrdinalIgnoreCase);
    }

    private static int GetSeverityOrder(ApLockSeverity severity) => severity switch
    {
        ApLockSeverity.Warning => 0,
        ApLockSeverity.Info => 1,
        _ => 2
    };

    private static int GetConfidenceOrder(DiagnosticConfidence confidence) => confidence switch
    {
        DiagnosticConfidence.High => 0,
        DiagnosticConfidence.Medium => 1,
        DiagnosticConfidence.Low => 2,
        _ => 3
    };

    private async Task RunDiagnostics()
    {
        _isRunning = true;
        StateHasChanged();

        try
        {
            var options = new DiagnosticsOptions
            {
                RunApLockAnalyzer = _runApLockAnalyzer,
                RunTrunkConsistencyAnalyzer = _runTrunkConsistency,
                RunPortProfileSuggestionAnalyzer = _runPortProfileSuggestions
            };

            _result = await DiagnosticsService.RunDiagnosticsAsync(options);
            InitializeCollapsedState();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to run diagnostics");
        }
        finally
        {
            _isRunning = false;
            StateHasChanged();
        }
    }

    // ApLockSeverity helpers
    private static string GetSeverityCssClass(ApLockSeverity severity) => severity switch
    {
        ApLockSeverity.Warning => "warning",
        ApLockSeverity.Info => "info",
        _ => "info"
    };

    private static string GetSeverityDisplayName(ApLockSeverity severity) => severity switch
    {
        ApLockSeverity.Warning => "Recommendation",
        ApLockSeverity.Info => "Info",
        _ => severity.ToString()
    };

    private static string GetSeverityIcon(ApLockSeverity severity) => severity switch
    {
        ApLockSeverity.Warning => WarningIcon,
        ApLockSeverity.Info => InfoIcon,
        _ => InfoIcon
    };

    private static string GetConfidenceCssClass(DiagnosticConfidence confidence) => confidence switch
    {
        DiagnosticConfidence.High => "warning",
        DiagnosticConfidence.Medium => "info",
        DiagnosticConfidence.Low => "info",
        _ => "info"
    };

    private static string GetConfidenceIcon(DiagnosticConfidence confidence) => confidence switch
    {
        DiagnosticConfidence.High => WarningIcon,
        DiagnosticConfidence.Medium => InfoIcon,
        DiagnosticConfidence.Low => InfoIcon,
        _ => InfoIcon
    };

    private static string GetSuggestionTypeDisplay(PortProfileSuggestionType type) => type switch
    {
        PortProfileSuggestionType.CreateNew => "Create Profile",
        PortProfileSuggestionType.ApplyExisting => "Apply Profile",
        PortProfileSuggestionType.ExtendUsage => "Extend Profile",
        _ => type.ToString()
    };

    private static string FormatLastSeen(DateTime lastSeen)
    {
        var ago = DateTime.UtcNow - lastSeen;

        if (ago.TotalMinutes < 60)
            return $"{(int)ago.TotalMinutes}m ago";
        if (ago.TotalHours < 24)
            return $"{(int)ago.TotalHours}h ago";
        if (ago.TotalDays < 7)
            return $"{(int)ago.TotalDays}d ago";

        return lastSeen.ToLocalTime().ToString("MMM d");
    }
}
