@page "/client-dashboard"
@rendermode InteractiveServer
@implements IDisposable
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Web.Models
@using NetworkOptimizer.UniFi.Models
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Core.Helpers
@using NetworkOptimizer.WiFi.Models
@using Microsoft.AspNetCore.Http
@using ApexCharts
@inject ClientDashboardService DashboardService
@inject ClientSpeedTestService SpeedTestService
@inject UniFiConnectionService ConnectionService
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject IHttpContextAccessor HttpContextAccessor

<div class="client-dashboard-page">
    @* Back Link *@
    <div class="page-back-link">
        <a href="/" class="back-link">
            <span class="back-arrow">‚Üê</span> Home
        </a>
    </div>

    @* Page Header *@
    <div class="page-header">
        <h1>Client Dashboard</h1>
        <p class="page-description">Real-time signal quality, speed performance, and connection history for your device.</p>
    </div>

    @if (!ConnectionService.IsConnected && ConnectionService.IsInitialized)
    {
        <div class="connection-banner">
            <div class="banner-content">
                <span class="banner-icon">!</span>
                <div class="banner-text">
                    <strong>Not Connected</strong>
                    <span>Unable to reach the UniFi controller. Signal polling is paused.</span>
                </div>
                <a href="/settings" class="btn btn-primary btn-sm">Check Settings</a>
            </div>
        </div>
    }
    else if (_consecutiveFailures >= 3)
    {
        <div class="connection-banner">
            <div class="banner-content">
                <span class="banner-icon">!</span>
                <div class="banner-text">
                    <strong>Polling Interrupted</strong>
                    <span>@_consecutiveFailures consecutive polls failed. Retrying...</span>
                </div>
            </div>
        </div>
    }

    @if (_loading)
    {
        <div class="skeleton-hero card">
            <div class="skeleton-row">
                <div class="skeleton-block skeleton-title"></div>
                <div class="skeleton-block skeleton-gauge"></div>
            </div>
            <div class="skeleton-row">
                <div class="skeleton-block skeleton-detail"></div>
                <div class="skeleton-block skeleton-detail"></div>
                <div class="skeleton-block skeleton-detail"></div>
                <div class="skeleton-block skeleton-detail"></div>
            </div>
        </div>
        <div class="skeleton-tabs">
            <div class="skeleton-block skeleton-tab"></div>
            <div class="skeleton-block skeleton-tab"></div>
            <div class="skeleton-block skeleton-tab"></div>
        </div>
        <div class="skeleton-chart card">
            <div class="skeleton-block skeleton-chart-area"></div>
        </div>
    }
    else if (_client == null)
    {
        <div class="card empty-state">
            <div class="empty-icon">üì°</div>
            <h3>Device Not Found</h3>
            <p>Could not identify your device on the network. Make sure you're connected via Wi-Fi and the UniFi controller is reachable.</p>
            <button class="btn btn-primary" @onclick="RetryIdentify">Retry</button>
        </div>
    }
    else
    {
        @* Device Identity Hero *@
        <div class="card identity-hero">
            <div class="hero-main">
                <div class="hero-device-info">
                    <h2 class="hero-device-name">@_client.DisplayName</h2>
                    <div class="hero-meta">
                        <span class="meta-item" data-tooltip="MAC Address">@_client.Mac</span>
                        <span class="meta-separator">¬∑</span>
                        <span class="meta-item" data-tooltip="IP Address">@_client.Ip</span>
                        @if (!string.IsNullOrEmpty(_client.Essid))
                        {
                            <span class="meta-separator">¬∑</span>
                            <span class="meta-item" data-tooltip="SSID">@_client.Essid</span>
                        }
                    </div>
                </div>
                @if (!_client.IsWired && _client.SignalDbm.HasValue)
                {
                    <div class="hero-signal">
                        <div class="signal-gauge @GetSignalClass(_client.SignalDbm.Value)">
                            <span class="signal-value">@_client.SignalDbm</span>
                            <span class="signal-unit">dBm</span>
                        </div>
                    </div>
                }
            </div>
            <div class="hero-details">
                @if (!_client.IsWired)
                {
                    <div class="hero-detail-item">
                        <span class="detail-label">Band</span>
                        <span class="detail-value band-badge @GetBandClass(_client.Band)">@(_client.BandDisplay ?? "‚Äî")</span>
                    </div>
                    <div class="hero-detail-item">
                        <span class="detail-label">Protocol</span>
                        <span class="detail-value">@FormatProtocol(_client.Protocol)</span>
                    </div>
                    <div class="hero-detail-item">
                        <span class="detail-label">AP</span>
                        <span class="detail-value">@(_client.ApName ?? "‚Äî")</span>
                    </div>
                    <div class="hero-detail-item">
                        <span class="detail-label">Channel</span>
                        <span class="detail-value">@(_client.Channel?.ToString() ?? "‚Äî")</span>
                    </div>
                    @if (_client.TxRateKbps.HasValue)
                    {
                        <div class="hero-detail-item">
                            <span class="detail-label">TX / RX</span>
                            <span class="detail-value">@FormatRate(_client.TxRateKbps) / @FormatRate(_client.RxRateKbps)</span>
                        </div>
                    }
                    @if (_client.IsMlo)
                    {
                        <div class="hero-detail-item">
                            <span class="detail-label">MLO</span>
                            <span class="detail-value badge-mlo">Active</span>
                        </div>
                    }
                }
                else
                {
                    <div class="hero-detail-item">
                        <span class="detail-label">Connection</span>
                        <span class="detail-value">Wired</span>
                    </div>
                }
                @if (_pollCount > 0)
                {
                    <div class="hero-detail-item hero-poll-indicator">
                        <span class="poll-dot"></span>
                        <span class="detail-value poll-label">Live</span>
                    </div>
                }
            </div>
        </div>

        @* Tabs + Time Filter *@
        <div class="dashboard-controls">
            <div class="tab-bar">
                <button class="tab-btn @(_activeTab == "speed" ? "active" : "")"
                        @onclick='() => SetActiveTab("speed")'>Speed</button>
                <button class="tab-btn @(_activeTab == "signal" ? "active" : "")"
                        @onclick='() => SetActiveTab("signal")'>Signal</button>
                <button class="tab-btn @(_activeTab == "connection" ? "active" : "")"
                        @onclick='() => SetActiveTab("connection")'>Connection</button>
            </div>
            <div class="time-range-selector">
                @foreach (var tf in _timeFilters)
                {
                    <button class="time-btn @(_selectedTimeFilter == tf.hours ? "active" : "")"
                            @onclick="() => SetTimeFilter(tf.hours)">@tf.label</button>
                }
            </div>
        </div>

        @* Tab Content *@
        <div class="tab-content">
            @if (_tabLoading)
            {
                <div class="tab-loading">
                    <span class="spinner"></span>
                </div>
            }
            @if (_activeTab == "speed")
            {
                @* ===== SPEED TAB ===== *@
                <div class="tab-pane">
                    @if (_latestSpeedResult != null)
                    {
                        <div class="card speed-hero">
                            <div class="speed-hero-results">
                                <div class="speed-metric download">
                                    <span class="speed-label">From Device</span>
                                    <span class="speed-value @GetSpeedClass(_latestSpeedResult.DownloadMbps)">@_latestSpeedResult.DownloadMbps.ToString("F1")</span>
                                    <span class="speed-unit">Mbps</span>
                                </div>
                                <div class="speed-metric upload">
                                    <span class="speed-label">To Device</span>
                                    <span class="speed-value @GetSpeedClass(_latestSpeedResult.UploadMbps)">@_latestSpeedResult.UploadMbps.ToString("F1")</span>
                                    <span class="speed-unit">Mbps</span>
                                </div>
                                @if (_latestSpeedResult.PingMs.HasValue)
                                {
                                    <div class="speed-metric ping">
                                        <span class="speed-label">Ping</span>
                                        <span class="speed-value">@_latestSpeedResult.PingMs.Value.ToString("F1")</span>
                                        <span class="speed-unit">ms</span>
                                    </div>
                                }
                                @if (_latestSpeedResult.JitterMs.HasValue)
                                {
                                    <div class="speed-metric jitter">
                                        <span class="speed-label">Jitter</span>
                                        <span class="speed-value">@_latestSpeedResult.JitterMs.Value.ToString("F1")</span>
                                        <span class="speed-unit">ms</span>
                                    </div>
                                }
                                @if (_latestSpeedResult.DownloadLatencyMs.HasValue || _latestSpeedResult.UploadLatencyMs.HasValue)
                                {
                                    <div class="speed-metric loaded-latency">
                                        <span class="speed-label">Loaded Latency</span>
                                        <span class="speed-value">@((_latestSpeedResult.DownloadLatencyMs ?? _latestSpeedResult.UploadLatencyMs)?.ToString("F1"))</span>
                                        <span class="speed-unit">ms</span>
                                    </div>
                                }
                            </div>
                            <div class="speed-hero-meta">
                                <span>@_latestSpeedResult.TestTime.ToLocalTime().ToString("g")</span>
                                <span>@_latestSpeedResult.DurationSeconds s test</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <p>No speed tests yet. Run a test to see results here.</p>
                        </div>
                    }

                    @* Speed Test Buttons *@
                    @if (!string.IsNullOrEmpty(_openSpeedTestUrl))
                    {
                        <div class="speed-actions">
                            <a href="@(_openSpeedTestUrl)?Run" target="_blank" class="btn btn-primary btn-lg">
                                Run Speed Test
                            </a>
                            <a href="@(_openSpeedTestUrl)?S=5&Run" target="_blank" class="btn btn-secondary btn-lg"
                               data-tooltip="5-second quick test (~15s total)" data-tooltip-hover-only>
                                Quick Test
                            </a>
                        </div>
                    }

                    @* Speed History Chart *@
                    @if (_speedChartData.Count > 0)
                    {
                        <div class="card chart-card">
                            <h3>Speed History</h3>
                            <div class="chart-container">
                                <ApexChart @key="_chartKey" @ref="_speedChart" TItem="SpeedChartPoint"
                                           Options="_speedChartOptions"
                                           Height="@("250px")">
                                    <ApexPointSeries TItem="SpeedChartPoint"
                                                     Items="SpeedDownloadData"
                                                     Name="From Device"
                                                     SeriesType="SeriesType.Area"
                                                     XValue="e => e.Timestamp"
                                                     YValue="e => e.Value"
                                                     OrderBy="e => e.X" />
                                    <ApexPointSeries TItem="SpeedChartPoint"
                                                     Items="SpeedUploadData"
                                                     Name="To Device"
                                                     SeriesType="SeriesType.Area"
                                                     XValue="e => e.Timestamp"
                                                     YValue="e => e.Value"
                                                     OrderBy="e => e.X" />
                                </ApexChart>
                            </div>
                        </div>
                    }

                    @* Latency History Chart *@
                    @if (_latencyChartData.Count > 0)
                    {
                        <div class="card chart-card">
                            <h3>Latency History</h3>
                            <div class="chart-container">
                                <ApexChart @key="_chartKey" TItem="SpeedChartPoint"
                                           Options="_latencyChartOptions"
                                           Height="@("200px")">
                                    <ApexPointSeries TItem="SpeedChartPoint"
                                                     Items="LatencyPingData"
                                                     Name="Ping"
                                                     SeriesType="SeriesType.Line"
                                                     XValue="e => e.Timestamp"
                                                     YValue="e => e.Value"
                                                     OrderBy="e => e.X" />
                                    <ApexPointSeries TItem="SpeedChartPoint"
                                                     Items="LatencyJitterData"
                                                     Name="Jitter"
                                                     SeriesType="SeriesType.Line"
                                                     XValue="e => e.Timestamp"
                                                     YValue="e => e.Value"
                                                     OrderBy="e => e.X" />
                                </ApexChart>
                            </div>
                        </div>
                    }

                    @* Speed Results Table *@
                    @if (_speedResults.Count > 0)
                    {
                        <div class="card results-card">
                            <h3>Test Results</h3>
                            <div class="results-table-container">
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>From Device</th>
                                            <th>To Device</th>
                                            <th>Ping</th>
                                            <th>Duration</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var r in _speedResults)
                                        {
                                            <tr class="result-row @(_expandedResultId == r.Id ? "expanded" : "")"
                                                @onclick="() => ToggleResultExpand(r.Id)">
                                                <td>@r.TestTime.ToLocalTime().ToString("g")</td>
                                                <td class="@GetSpeedClass(r.DownloadMbps)">@r.DownloadMbps.ToString("F1") Mbps</td>
                                                <td class="@GetSpeedClass(r.UploadMbps)">@r.UploadMbps.ToString("F1") Mbps</td>
                                                <td>@(r.PingMs?.ToString("F1") ?? "‚Äî") ms</td>
                                                <td>@r.DurationSeconds s</td>
                                                <td>@(r.Direction == SpeedTestDirection.BrowserToServer ? "Browser" : "iperf3")</td>
                                            </tr>
                                            @if (_expandedResultId == r.Id)
                                            {
                                                <tr class="result-details-row">
                                                    <td colspan="6">
                                                        <div class="result-details">
                                                            <SpeedTestDetails Result="r" />
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                    @* Speed Map (wireless clients only) *@
                    @if (!(_client?.IsWired == true) && _speedResults.Any(r => r.Latitude.HasValue))
                    {
                        <SpeedTestMap Results="_speedResults" MapHeight="400px" />
                    }
                </div>
            }
            else if (_activeTab == "signal")
            {
                @* ===== SIGNAL TAB ===== *@
                <div class="tab-pane">
                    @if (!_client.IsWired && _client.SignalDbm.HasValue)
                    {
                        <div class="card signal-hero-live">
                            <div class="signal-main">
                                <div class="signal-gauge-large @GetSignalClass(_client.SignalDbm.Value)">
                                    <span class="signal-value-large">@_client.SignalDbm</span>
                                    <span class="signal-unit-large">dBm</span>
                                </div>
                                <div class="signal-bars @GetSignalClass(_client.SignalDbm.Value)">
                                    @for (int i = 0; i < 5; i++)
                                    {
                                        var barThreshold = -80 + (i * 10); // -80, -70, -60, -50, -40
                                        <div class="bar @(_client.SignalDbm >= barThreshold ? "active" : "")"></div>
                                    }
                                </div>
                            </div>
                            <div class="signal-details-grid">
                                <div class="signal-detail">
                                    <span class="detail-label">Band</span>
                                    <span class="detail-value band-badge @GetBandClass(_client.Band)">@(_client.BandDisplay ?? "‚Äî")</span>
                                </div>
                                <div class="signal-detail">
                                    <span class="detail-label">AP</span>
                                    <span class="detail-value">@(_client.ApName ?? "‚Äî")</span>
                                </div>
                                <div class="signal-detail">
                                    <span class="detail-label">Channel</span>
                                    <span class="detail-value">@(_client.Channel?.ToString() ?? "‚Äî")</span>
                                </div>
                                @if (_client.ApModel != null)
                                {
                                    <div class="signal-detail">
                                        <span class="detail-label">AP Model</span>
                                        <span class="detail-value">@_client.ApModel</span>
                                    </div>
                                }
                                @if (_client.TxRateKbps.HasValue)
                                {
                                    <div class="signal-detail">
                                        <span class="detail-label">TX Rate</span>
                                        <span class="detail-value">@FormatRate(_client.TxRateKbps)</span>
                                    </div>
                                    <div class="signal-detail">
                                        <span class="detail-label">RX Rate</span>
                                        <span class="detail-value">@FormatRate(_client.RxRateKbps)</span>
                                    </div>
                                }
                                @if (_client.NoiseDbm.HasValue)
                                {
                                    <div class="signal-detail">
                                        <span class="detail-label">Noise</span>
                                        <span class="detail-value">@_client.NoiseDbm dBm</span>
                                    </div>
                                    <div class="signal-detail">
                                        <span class="detail-label">SNR</span>
                                        <span class="detail-value">@(_client.SignalDbm - _client.NoiseDbm) dB</span>
                                    </div>
                                }
                                @if (_client.ApClientCount.HasValue)
                                {
                                    <div class="signal-detail">
                                        <span class="detail-label">AP Clients</span>
                                        <span class="detail-value">@_client.ApClientCount</span>
                                    </div>
                                }
                                @if (_client.ApTxPower.HasValue)
                                {
                                    <div class="signal-detail">
                                        <span class="detail-label">AP TX Power</span>
                                        <span class="detail-value">@_client.ApTxPower dBm</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else if (_client.IsWired)
                    {
                        <div class="empty-state">
                            <p>Signal data is only available for wireless clients. This device is connected via Ethernet.</p>
                        </div>
                    }

                    @* Signal History Chart (wireless only) *@
                    @if (_signalChartData.Count > 0 && !(_client?.IsWired == true))
                    {
                        <div class="card chart-card">
                            <h3>Signal History</h3>
                            <div class="chart-container">
                                <ApexChart @key="_chartKey" @ref="_signalChart" TItem="SignalChartPoint"
                                           Options="_signalChartOptions"
                                           Height="@("250px")">
                                    <ApexPointSeries TItem="SignalChartPoint"
                                                     Items="_signalChartData"
                                                     Name="Signal (dBm)"
                                                     SeriesType="SeriesType.Line"
                                                     XValue="e => e.Timestamp"
                                                     YValue="e => e.Value"
                                                     OrderBy="e => e.X" />
                                </ApexChart>
                            </div>
                        </div>
                    }

                    @* Signal History Table (wireless only) *@
                    @if (_signalHistory.Count > 0 && !(_client?.IsWired == true))
                    {
                        <div class="card results-card">
                            <h3>Signal Log</h3>
                            <div class="results-table-container">
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th class="sortable @(_signalSortCol == "time" ? "sorted" : "")" @onclick='() => ToggleSignalSort("time")'>Time @SortIndicator("time")</th>
                                            <th class="sortable @(_signalSortCol == "signal" ? "sorted" : "")" @onclick='() => ToggleSignalSort("signal")'>Signal @SortIndicator("signal")</th>
                                            <th class="sortable @(_signalSortCol == "band" ? "sorted" : "")" @onclick='() => ToggleSignalSort("band")'>Band @SortIndicator("band")</th>
                                            <th class="sortable @(_signalSortCol == "ap" ? "sorted" : "")" @onclick='() => ToggleSignalSort("ap")'>AP @SortIndicator("ap")</th>
                                            <th class="sortable @(_signalSortCol == "channel" ? "sorted" : "")" @onclick='() => ToggleSignalSort("channel")'>Channel @SortIndicator("channel")</th>
                                            <th>TX Rate</th>
                                            <th>RX Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var entry in GetSortedSignalHistory())
                                        {
                                            <tr class="@(entry.DataSource == SignalDataSource.UniFiController ? "unifi-source-row" : "")">
                                                <td>
                                                    @entry.Timestamp.ToLocalTime().ToString("HH:mm:ss")
                                                    @if (entry.DataSource == SignalDataSource.UniFiController)
                                                    {
                                                        <span class="source-dot" data-tooltip="UniFi controller data"></span>
                                                    }
                                                </td>
                                                <td class="@GetSignalClass(entry.SignalDbm ?? 0)">@(entry.SignalDbm?.ToString() ?? "‚Äî") dBm</td>
                                                <td>@FormatBand(entry.Band)</td>
                                                <td>@(entry.ApName ?? "‚Äî")</td>
                                                <td>@(entry.Channel?.ToString() ?? "‚Äî")</td>
                                                <td>@FormatRate(entry.TxRateKbps)</td>
                                                <td>@FormatRate(entry.RxRateKbps)</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (_activeTab == "connection")
            {
                @* ===== CONNECTION TAB ===== *@
                <div class="tab-pane">
                    @* Connection Hero *@
                    <div class="card connection-hero">
                        <div class="connection-hero-grid">
                            <div class="connection-detail">
                                <span class="detail-label">@(_client.IsWired ? "Switch / Gateway" : "Current AP")</span>
                                <span class="detail-value">@(_client.ApName ?? "‚Äî")</span>
                            </div>
                            @if (_client.ApModel != null)
                            {
                                <div class="connection-detail">
                                    <span class="detail-label">@(_client.IsWired ? "Model" : "AP Model")</span>
                                    <span class="detail-value">@_client.ApModel</span>
                                </div>
                            }
                            @if (!_client.IsWired)
                            {
                                <div class="connection-detail">
                                    <span class="detail-label">Band</span>
                                    <span class="detail-value band-badge @GetBandClass(_client.Band)">@(_client.BandDisplay ?? "‚Äî")</span>
                                </div>
                                <div class="connection-detail">
                                    <span class="detail-label">Channel</span>
                                    <span class="detail-value">@(_client.Channel?.ToString() ?? "‚Äî")</span>
                                </div>
                                @if (_client.SignalDbm.HasValue)
                                {
                                    <div class="connection-detail">
                                        <span class="detail-label">Signal</span>
                                        <span class="detail-value @GetSignalClass(_client.SignalDbm.Value)">@_client.SignalDbm dBm</span>
                                    </div>
                                }
                                @if (_client.TxRateKbps.HasValue)
                                {
                                    <div class="connection-detail">
                                        <span class="detail-label">TX / RX</span>
                                        <span class="detail-value">@FormatRate(_client.TxRateKbps) / @FormatRate(_client.RxRateKbps)</span>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    @* Live L2 Trace *@
                    @if (_latestPoll?.PathAnalysis != null)
                    {
                        <div class="card trace-card">
                            <h3>Network Path</h3>
                            <SpeedTestDetails PathAnalysis="_latestPoll.PathAnalysis" PathOnly="true" />
                        </div>
                    }

                    @* Connection History Graph *@
                    @if (_connectionEvents.Count > 1)
                    {
                        <div class="card chart-card">
                            <h3>Connection History</h3>
                            <div class="chart-container">
                                <ApexChart @key="_chartKey" TItem="ConnectionChartPoint"
                                           Options="_connectionChartOptions"
                                           Height="@("200px")">
                                    <ApexPointSeries TItem="ConnectionChartPoint"
                                                     Items="_connectionChartData"
                                                     Name="AP"
                                                     SeriesType="SeriesType.Scatter"
                                                     XValue="e => e.Timestamp"
                                                     YValue="e => e.ApIndex"
                                                     OrderBy="e => e.X" />
                                </ApexChart>
                            </div>
                        </div>
                    }

                    @* Connection Events (from UniFi controller) *@
                    @if (_connectionEvents.Count > 0)
                    {
                        <div class="card results-card">
                            <h3>Connection Events</h3>
                            <div class="results-table-container">
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Event</th>
                                            <th>@(_client?.IsWired == true ? "Switch / Gateway" : "AP")</th>
                                            @if (!(_client?.IsWired == true))
                                            {
                                                <th>Band</th>
                                                <th>Signal</th>
                                            }
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var evt in _connectionEvents)
                                        {
                                            <tr class="@GetEventRowClass(evt.Type)">
                                                <td>@evt.Timestamp.ToLocalTime().ToString("g")</td>
                                                <td>
                                                    <span class="event-badge @GetEventBadgeClass(evt.Type)">
                                                        @FormatEventType(evt.Type)
                                                    </span>
                                                </td>
                                                <td>
                                                    @if (evt.Type == ClientConnectionEventType.Roamed)
                                                    {
                                                        <span>@(evt.FromApName ?? "?") ‚Üí @(evt.ToApName ?? evt.ApName ?? "?")</span>
                                                    }
                                                    else
                                                    {
                                                        @(evt.ApName ?? "‚Äî")
                                                    }
                                                </td>
                                                @if (!(_client?.IsWired == true))
                                                {
                                                    <td>@(evt.GetRadioBandDisplay() ?? "‚Äî")</td>
                                                    <td class="@GetSignalClass(evt.Signal ?? 0)">@(evt.Signal?.ToString() ?? "‚Äî") dBm</td>
                                                }
                                                <td class="event-details-cell">
                                                    @if (evt.Type == ClientConnectionEventType.Roamed && evt.PreviousSignal.HasValue)
                                                    {
                                                        <span data-tooltip="Signal before roam">@evt.PreviousSignal dBm ‚Üí @evt.Signal dBm</span>
                                                    }
                                                    else if (evt.Type == ClientConnectionEventType.Disconnected && evt.Duration != null)
                                                    {
                                                        <span data-tooltip="Session duration">@evt.Duration</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <p>No connection events found in the selected time window.</p>
                        </div>
                    }

                    @* Trace History *@
                    @if (_traceHistory.Count > 0)
                    {
                        <div class="card results-card">
                            <h3>Trace Changes</h3>
                            <div class="results-table-container">
                                <table class="results-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Hops</th>
                                            <th>Bottleneck</th>
                                            <th>Change</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < _traceHistory.Count; i++)
                                        {
                                            var trace = _traceHistory[i];
                                            var prev = i < _traceHistory.Count - 1 ? _traceHistory[i + 1] : null;
                                            <tr class="result-row @(_expandedTraceTimestamp == trace.Timestamp ? "expanded" : "")"
                                                @onclick="() => ToggleTraceExpand(trace.Timestamp)">
                                                <td>@trace.Timestamp.ToLocalTime().ToString("HH:mm:ss")</td>
                                                <td>@(trace.HopCount?.ToString() ?? "‚Äî")</td>
                                                <td>@(trace.BottleneckLinkSpeedMbps?.ToString("F0") ?? "‚Äî") Mbps</td>
                                                <td class="trace-change-cell">
                                                    @if (prev != null)
                                                    {
                                                        @FormatTraceChange(prev, trace)
                                                    }
                                                    else
                                                    {
                                                        <span class="trace-initial">Initial</span>
                                                    }
                                                </td>
                                            </tr>
                                            @if (_expandedTraceTimestamp == trace.Timestamp && trace.PathAnalysis != null)
                                            {
                                                <tr class="result-details-row">
                                                    <td colspan="4">
                                                        <div class="result-details">
                                                            <SpeedTestDetails PathAnalysis="trace.PathAnalysis" PathOnly="true" />
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "tab")]
    public string? TabParam { get; set; }

    // State
    private bool _loading = true;
    private bool _tabLoading;
    private ClientIdentity? _client;
    private SignalPollResult? _latestPoll;
    private string _activeTab = "speed";
    private int _selectedTimeFilter = 24; // hours, default 24h
    private int _pollCount;
    private int _consecutiveFailures;

    // Speed tab
    private List<Iperf3Result> _speedResults = new();
    private Iperf3Result? _latestSpeedResult;
    private List<SpeedChartPoint> _speedChartData = new();
    private ApexChart<SpeedChartPoint>? _speedChart;
    private ApexChartOptions<SpeedChartPoint> _speedChartOptions = new();
    private List<SpeedChartPoint> _latencyChartData = new();
    private ApexChartOptions<SpeedChartPoint> _latencyChartOptions = new();
    private int? _expandedResultId;
    private string? _openSpeedTestUrl;

    // Signal tab
    private List<SignalHistoryEntry> _signalHistory = new();
    private List<SignalChartPoint> _signalChartData = new();
    private ApexChart<SignalChartPoint>? _signalChart;
    private ApexChartOptions<SignalChartPoint> _signalChartOptions = new();

    // Signal table sorting
    private string _signalSortCol = "time";
    private bool _signalSortAsc = false;

    // Connection tab
    private List<TraceChangeEntry> _traceHistory = new();
    private List<ClientConnectionEvent> _connectionEvents = new();
    private DateTime? _expandedTraceTimestamp;
    private List<ConnectionChartPoint> _connectionChartData = new();
    private ApexChartOptions<ConnectionChartPoint> _connectionChartOptions = new();

    // Chart re-render key (incremented on time filter change to force chart recreation)
    private int _chartKey;

    // Polling
    private System.Threading.Timer? _pollTimer;

    // GPS
    private double? _gpsLat;
    private double? _gpsLng;
    private int? _gpsAccuracy;

    // Time filter options
    private static readonly (int hours, string label)[] _timeFilters = new[]
    {
        (1, "1h"),
        (6, "6h"),
        (24, "24h"),
        (168, "7d"),
        (720, "30d"),
        (0, "All")
    };

    protected override async Task OnInitializedAsync()
    {
        // Parse tab from URL
        if (!string.IsNullOrEmpty(TabParam))
        {
            _activeTab = TabParam.ToLowerInvariant() switch
            {
                "signal" => "signal",
                "connection" => "connection",
                _ => "speed"
            };
        }

        // Build OpenSpeedTest URL
        BuildOpenSpeedTestUrl();

        // Configure charts
        ConfigureSpeedChart();
        ConfigureLatencyChart();
        ConfigureSignalChart();

        // Identify client
        await IdentifyAndLoadAsync();

        // Request GPS location (fire-and-forget, non-blocking)
        _ = RequestGpsAsync();

        // Start polling every 5 seconds
        _pollTimer = new System.Threading.Timer(async _ =>
        {
            try
            {
                await InvokeAsync(async () =>
                {
                    await PollAsync();
                    StateHasChanged();
                });
                _consecutiveFailures = 0;

                // Run daily cleanup check (non-blocking)
                _ = DashboardService.TryCleanupAsync();
            }
            catch
            {
                _consecutiveFailures++;
                try { await InvokeAsync(StateHasChanged); } catch { }
            }
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task IdentifyAndLoadAsync()
    {
        _loading = true;

        try
        {
            // We don't have direct access to HttpContext IP in Blazor Server,
            // so we use JS interop to get the page URL and call the API
            _client = await GetClientIdentityAsync();

            if (_client != null)
            {
                await LoadTabDataAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to identify client: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private string? _clientIp;

    private async Task<ClientIdentity?> GetClientIdentityAsync()
    {
        // In Blazor Server, HttpContext is only available during the initial HTTP request.
        // OnInitializedAsync runs during that first request, so we capture the IP here.
        if (string.IsNullOrEmpty(_clientIp))
        {
            var httpContext = HttpContextAccessor.HttpContext;
            if (httpContext != null)
            {
                var clientIp = httpContext.Connection.RemoteIpAddress?.ToString() ?? "unknown";
                var forwardedFor = httpContext.Request.Headers["X-Forwarded-For"].FirstOrDefault();
                if (!string.IsNullOrEmpty(forwardedFor))
                {
                    clientIp = forwardedFor.Split(',')[0].Trim();
                }
                _clientIp = clientIp;
            }
        }

        if (string.IsNullOrEmpty(_clientIp) || _clientIp == "unknown")
            return null;

        return await DashboardService.IdentifyClientAsync(_clientIp);
    }

    private async Task PollAsync()
    {
        if (string.IsNullOrEmpty(_clientIp))
            return;

        try
        {
            _latestPoll = await DashboardService.PollSignalAsync(
                _clientIp, _gpsLat, _gpsLng, _gpsAccuracy);
            if (_latestPoll != null)
            {
                _client = _latestPoll.Client;
                _pollCount++;

                // Refresh the active tab data periodically (every 6 polls = ~30s)
                if (_pollCount % 6 == 0)
                {
                    await LoadTabDataAsync();
                }

                // Add to live signal chart data
                if (_activeTab == "signal" && _client.SignalDbm.HasValue)
                {
                    _signalChartData.Add(new SignalChartPoint(
                        _latestPoll.Timestamp, (decimal)_client.SignalDbm.Value));

                    // Keep last 360 points (30 min at 5s interval)
                    if (_signalChartData.Count > 360)
                        _signalChartData.RemoveAt(0);
                }

                // Refresh connection data when trace changes or periodically (every 12 polls = ~60s)
                if (_activeTab == "connection" && (_latestPoll.TraceChanged || _pollCount % 12 == 0))
                {
                    var (f, t) = GetTimeRange();
                    await LoadConnectionDataAsync(f, t);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Poll failed: {ex.Message}");
        }
    }

    private async Task LoadTabDataAsync()
    {
        if (_client == null) return;

        var (from, to) = GetTimeRange();

        switch (_activeTab)
        {
            case "speed":
                await LoadSpeedDataAsync(from, to);
                break;
            case "signal":
                await LoadSignalDataAsync(from, to);
                break;
            case "connection":
                await LoadConnectionDataAsync(from, to);
                break;
        }
    }

    private async Task LoadSpeedDataAsync(DateTime from, DateTime to)
    {
        _speedResults = await DashboardService.GetSpeedResultsAsync(_client!.Mac, from, to);
        _latestSpeedResult = _speedResults.FirstOrDefault();

        // Build chart data
        _speedChartData.Clear();
        _latencyChartData.Clear();
        foreach (var r in _speedResults.OrderBy(r => r.TestTime))
        {
            _speedChartData.Add(new SpeedChartPoint(r.TestTime, (decimal)r.DownloadMbps, "download"));
            _speedChartData.Add(new SpeedChartPoint(r.TestTime, (decimal)r.UploadMbps, "upload"));

            if (r.PingMs.HasValue)
                _latencyChartData.Add(new SpeedChartPoint(r.TestTime, (decimal)r.PingMs.Value, "ping"));
            if (r.JitterMs.HasValue)
                _latencyChartData.Add(new SpeedChartPoint(r.TestTime, (decimal)r.JitterMs.Value, "jitter"));
        }
    }

    private async Task LoadSignalDataAsync(DateTime from, DateTime to)
    {
        // Use merged history (local high-res + UniFi controller data)
        _signalHistory = await DashboardService.GetMergedSignalHistoryAsync(_client!.Mac, from, to);

        // Build chart data from history
        _signalChartData = _signalHistory
            .Where(h => h.SignalDbm.HasValue)
            .Select(h => new SignalChartPoint(h.Timestamp, (decimal)h.SignalDbm!.Value))
            .ToList();

        // Build chart annotations for band/AP changes
        BuildSignalAnnotations();
    }

    private void BuildSignalAnnotations()
    {
        var annotations = new List<AnnotationsXAxis>();
        string? prevBand = null;
        string? prevAp = null;

        foreach (var entry in _signalHistory)
        {
            var ts = new DateTimeOffset(entry.Timestamp).ToUnixTimeMilliseconds();

            // Detect band change
            if (prevBand != null && entry.Band != null && entry.Band != prevBand)
            {
                annotations.Add(new AnnotationsXAxis
                {
                    X = ts,
                    BorderColor = "#a78bfa",
                    Label = new Label
                    {
                        Text = FormatBand(entry.Band),
                        Style = new Style { Background = "#a78bfa", Color = "#fff", FontSize = "10px" },
                        Orientation = Orientation.Horizontal
                    }
                });
            }

            // Detect AP roam
            if (prevAp != null && entry.ApName != null && entry.ApName != prevAp)
            {
                annotations.Add(new AnnotationsXAxis
                {
                    X = ts,
                    BorderColor = "#3b82f6",
                    Label = new Label
                    {
                        Text = entry.ApName,
                        Style = new Style { Background = "#3b82f6", Color = "#fff", FontSize = "10px" },
                        Orientation = Orientation.Horizontal
                    }
                });
            }

            if (entry.Band != null) prevBand = entry.Band;
            if (entry.ApName != null) prevAp = entry.ApName;
        }

        _signalChartOptions.Annotations = new Annotations { Xaxis = annotations };
    }

    private async Task LoadConnectionDataAsync(DateTime from, DateTime to)
    {
        // Load trace history and UniFi connection events in parallel
        var traceTask = DashboardService.GetTraceHistoryAsync(_client!.Mac, from, to);
        var eventsTask = DashboardService.GetConnectionEventsAsync(_client.Mac);

        await Task.WhenAll(traceTask, eventsTask);

        _traceHistory = traceTask.Result;

        // Filter connection events to the selected time range
        _connectionEvents = eventsTask.Result
            .Where(e => e.Timestamp >= from && e.Timestamp <= to)
            .OrderByDescending(e => e.Timestamp)
            .ToList();

        // Build connection history chart data
        BuildConnectionChartData();
    }

    private void SetActiveTab(string tab)
    {
        if (_activeTab == tab) return;
        _activeTab = tab;
        _chartKey++; // Force chart recreation for new tab

        // Update URL without navigation
        var uri = NavigationManager.GetUriWithQueryParameter("tab", tab);
        NavigationManager.NavigateTo(uri, forceLoad: false, replace: true);

        // Load data for the new tab
        _ = InvokeAsync(async () =>
        {
            _tabLoading = true;
            StateHasChanged();
            await LoadTabDataAsync();
            _tabLoading = false;
            StateHasChanged();
        });
    }

    private void SetTimeFilter(int hours)
    {
        if (_selectedTimeFilter == hours) return;
        _selectedTimeFilter = hours;
        _chartKey++; // Force chart recreation with new data

        // Reload data for all tabs with new time range
        _ = InvokeAsync(async () =>
        {
            _tabLoading = true;
            StateHasChanged();
            await LoadTabDataAsync();
            _tabLoading = false;
            StateHasChanged();
        });
    }

    private (DateTime from, DateTime to) GetTimeRange()
    {
        var to = DateTime.UtcNow;
        var from = _selectedTimeFilter == 0
            ? DateTime.MinValue
            : to.AddHours(-_selectedTimeFilter);
        return (from, to);
    }

    private async Task RetryIdentify()
    {
        await IdentifyAndLoadAsync();
        StateHasChanged();
    }

    private void ToggleResultExpand(int resultId)
    {
        _expandedResultId = _expandedResultId == resultId ? null : resultId;
    }

    private void ToggleTraceExpand(DateTime timestamp)
    {
        _expandedTraceTimestamp = _expandedTraceTimestamp == timestamp ? null : timestamp;
    }

    // --- Signal Table Sorting ---

    private void ToggleSignalSort(string col)
    {
        if (_signalSortCol == col)
            _signalSortAsc = !_signalSortAsc;
        else
        {
            _signalSortCol = col;
            _signalSortAsc = col == "time" ? false : true; // default: time desc, others asc
        }
    }

    private string SortIndicator(string col)
    {
        if (_signalSortCol != col) return "";
        return _signalSortAsc ? "\u25B2" : "\u25BC";
    }

    private IEnumerable<SignalHistoryEntry> GetSortedSignalHistory()
    {
        var data = _signalHistory.AsEnumerable();
        data = _signalSortCol switch
        {
            "signal" => _signalSortAsc
                ? data.OrderBy(e => e.SignalDbm ?? int.MinValue)
                : data.OrderByDescending(e => e.SignalDbm ?? int.MinValue),
            "band" => _signalSortAsc
                ? data.OrderBy(e => e.Band ?? "")
                : data.OrderByDescending(e => e.Band ?? ""),
            "ap" => _signalSortAsc
                ? data.OrderBy(e => e.ApName ?? "")
                : data.OrderByDescending(e => e.ApName ?? ""),
            "channel" => _signalSortAsc
                ? data.OrderBy(e => e.Channel ?? 0)
                : data.OrderByDescending(e => e.Channel ?? 0),
            _ => _signalSortAsc
                ? data.OrderBy(e => e.Timestamp)
                : data.OrderByDescending(e => e.Timestamp)
        };
        return data.Take(100);
    }

    // --- Connection Event Helpers ---

    private static string GetEventBadgeClass(ClientConnectionEventType type) => type switch
    {
        ClientConnectionEventType.Connected => "event-connected",
        ClientConnectionEventType.Disconnected => "event-disconnected",
        ClientConnectionEventType.Roamed => "event-roamed",
        _ => ""
    };

    private static string GetEventRowClass(ClientConnectionEventType type) => type switch
    {
        ClientConnectionEventType.Disconnected => "event-row-disconnect",
        _ => ""
    };

    private static string FormatEventType(ClientConnectionEventType type) => type switch
    {
        ClientConnectionEventType.Connected => "Connected",
        ClientConnectionEventType.Disconnected => "Disconnected",
        ClientConnectionEventType.Roamed => "Roamed",
        _ => "Unknown"
    };

    private async Task RequestGpsAsync()
    {
        try
        {
            // Wrap browser geolocation in a Promise for JS interop
            var js = "new Promise((resolve) => { " +
                "if (!navigator.geolocation) { resolve(null); return; } " +
                "navigator.geolocation.getCurrentPosition(" +
                "(pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, acc: Math.round(pos.coords.accuracy) }), " +
                "() => resolve(null), " +
                "{ enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }" +
                "); })";
            var result = await JS.InvokeAsync<GpsResult?>("eval", js);

            if (result != null)
            {
                _gpsLat = result.Lat;
                _gpsLng = result.Lng;
                _gpsAccuracy = result.Acc;
            }
        }
        catch
        {
            // GPS is optional - don't fail if browser denies permission
        }
    }

    private class GpsResult
    {
        public double Lat { get; set; }
        public double Lng { get; set; }
        public int? Acc { get; set; }
    }

    // --- URL Construction ---

    private void BuildOpenSpeedTestUrl()
    {
        var hostName = Configuration["HOST_NAME"];
        var hostIp = Configuration["HOST_IP"];
        var openSpeedTestHost = Configuration["OPENSPEEDTEST_HOST"];
        var openSpeedTestPortConfig = Configuration["OPENSPEEDTEST_PORT"];
        var openSpeedTestPort = !string.IsNullOrEmpty(openSpeedTestPortConfig) ? openSpeedTestPortConfig : "3005";
        var openSpeedTestHttps = Configuration["OPENSPEEDTEST_HTTPS"]?.Equals("true", StringComparison.OrdinalIgnoreCase) == true;
        var openSpeedTestHttpsPortConfig = Configuration["OPENSPEEDTEST_HTTPS_PORT"];
        var openSpeedTestHttpsPort = !string.IsNullOrEmpty(openSpeedTestHttpsPortConfig) ? openSpeedTestHttpsPortConfig : "443";

        if (string.IsNullOrEmpty(openSpeedTestHost))
            openSpeedTestHost = hostName;

        if (!string.IsNullOrEmpty(openSpeedTestHost))
        {
            if (openSpeedTestHttps)
            {
                _openSpeedTestUrl = openSpeedTestHttpsPort == "443"
                    ? $"https://{openSpeedTestHost}"
                    : $"https://{openSpeedTestHost}:{openSpeedTestHttpsPort}";
            }
            else
            {
                _openSpeedTestUrl = $"http://{openSpeedTestHost}:{openSpeedTestPort}";
            }
        }
        else
        {
            var fallbackIp = !string.IsNullOrEmpty(hostIp) ? hostIp : NetworkUtilities.DetectLocalIpFromInterfaces();
            if (!string.IsNullOrEmpty(fallbackIp))
            {
                _openSpeedTestUrl = $"http://{fallbackIp}:{openSpeedTestPort}";
            }
        }
    }

    // --- Chart Configuration ---

    private void ConfigureSpeedChart()
    {
        _speedChartOptions = new ApexChartOptions<SpeedChartPoint>
        {
            Chart = new Chart
            {
                Background = "transparent",
                Toolbar = new Toolbar { Show = false },
                Zoom = new Zoom { Enabled = false }
            },
            Theme = new Theme { Mode = Mode.Dark },
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels
                {
                    DatetimeFormatter = new DatetimeFormatter
                    {
                        Hour = "HH:mm",
                        Day = "MMM dd"
                    }
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Title = new AxisTitle { Text = "Mbps" },
                    Min = 0
                }
            },
            Colors = new List<string> { "#2ba89a", "#3b82f6" },
            Stroke = new Stroke { Width = 2, Curve = Curve.Smooth },
            Fill = new Fill { Opacity = new Opacity(0.15) },
            Grid = new Grid
            {
                BorderColor = "rgba(255,255,255,0.08)"
            },
            Tooltip = new Tooltip
            {
                Theme = Mode.Dark,
                X = new TooltipX { Format = "MMM dd HH:mm" }
            },
            Legend = new Legend { Show = true, Position = LegendPosition.Top }
        };
    }

    private void ConfigureLatencyChart()
    {
        _latencyChartOptions = new ApexChartOptions<SpeedChartPoint>
        {
            Chart = new Chart
            {
                Background = "transparent",
                Toolbar = new Toolbar { Show = false },
                Zoom = new Zoom { Enabled = false }
            },
            Theme = new Theme { Mode = Mode.Dark },
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels
                {
                    DatetimeFormatter = new DatetimeFormatter { Hour = "HH:mm", Day = "MMM dd" }
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis { Title = new AxisTitle { Text = "ms" }, Min = 0 }
            },
            Colors = new List<string> { "#f59e0b", "#a78bfa" },
            Stroke = new Stroke { Width = 2, Curve = Curve.Smooth },
            Grid = new Grid { BorderColor = "rgba(255,255,255,0.08)" },
            Tooltip = new Tooltip
            {
                Theme = Mode.Dark,
                X = new TooltipX { Format = "MMM dd HH:mm" }
            },
            Legend = new Legend { Show = true, Position = LegendPosition.Top }
        };
    }

    private void ConfigureSignalChart()
    {
        _signalChartOptions = new ApexChartOptions<SignalChartPoint>
        {
            Chart = new Chart
            {
                Background = "transparent",
                Toolbar = new Toolbar { Show = false },
                Zoom = new Zoom { Enabled = false }
            },
            Theme = new Theme { Mode = Mode.Dark },
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels
                {
                    DatetimeFormatter = new DatetimeFormatter
                    {
                        Hour = "HH:mm",
                        Day = "MMM dd"
                    }
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Title = new AxisTitle { Text = "dBm" },
                    Reversed = true, // Stronger signal = higher on chart
                    Min = -90,
                    Max = -20
                }
            },
            Colors = new List<string> { "#3b82f6" },
            Stroke = new Stroke { Width = 2, Curve = Curve.Smooth },
            Grid = new Grid
            {
                BorderColor = "rgba(255,255,255,0.08)"
            },
            Tooltip = new Tooltip
            {
                Theme = Mode.Dark,
                X = new TooltipX { Format = "MMM dd HH:mm:ss" }
            },
            Legend = new Legend { Show = false }
        };
    }

    // --- Formatting Helpers ---

    private static string GetSignalClass(int dbm) => dbm switch
    {
        >= -55 => "signal-excellent",
        >= -67 => "signal-good",
        >= -75 => "signal-fair",
        >= -80 => "signal-weak",
        _ => "signal-poor"
    };

    private static string GetBandClass(string? band) => band switch
    {
        "6e" or "6g" => "band-6ghz",
        "na" or "5g" => "band-5ghz",
        "ng" or "2g" => "band-2ghz",
        _ => ""
    };

    private static string GetSpeedClass(double mbps) => mbps switch
    {
        >= 500 => "speed-excellent",
        >= 100 => "speed-good",
        >= 30 => "speed-fair",
        _ => "speed-poor"
    };

    private static string FormatProtocol(string? proto) => proto switch
    {
        "be" => "Wi-Fi 7 (BE)",
        "ax" => "Wi-Fi 6 (AX)",
        "ac" => "Wi-Fi 5 (AC)",
        "n" => "Wi-Fi 4 (N)",
        _ => proto ?? "‚Äî"
    };

    private static string FormatRate(long? rateKbps)
    {
        if (!rateKbps.HasValue || rateKbps == 0) return "‚Äî";
        return $"{rateKbps.Value / 1000.0:F0} Mbps";
    }

    private static string FormatBand(string? band) => band switch
    {
        "ng" => "2.4 GHz",
        "na" => "5 GHz",
        "6e" => "6 GHz",
        _ => band ?? "‚Äî"
    };

    // --- Computed Chart Data ---

    private List<SpeedChartPoint> SpeedDownloadData =>
        _speedChartData.Where(p => p.Series == "download").ToList();

    private List<SpeedChartPoint> SpeedUploadData =>
        _speedChartData.Where(p => p.Series == "upload").ToList();

    private List<SpeedChartPoint> LatencyPingData =>
        _latencyChartData.Where(p => p.Series == "ping").ToList();

    private List<SpeedChartPoint> LatencyJitterData =>
        _latencyChartData.Where(p => p.Series == "jitter").ToList();

    // --- Chart Data Classes ---

    private class SpeedChartPoint
    {
        public DateTime Timestamp { get; set; }
        public decimal Value { get; set; }
        public string Series { get; set; } = "";
        public long X => new DateTimeOffset(Timestamp).ToUnixTimeMilliseconds();

        public SpeedChartPoint(DateTime timestamp, decimal value, string series)
        {
            Timestamp = timestamp;
            Value = value;
            Series = series;
        }
    }

    private class SignalChartPoint
    {
        public DateTime Timestamp { get; set; }
        public decimal Value { get; set; }
        public long X => new DateTimeOffset(Timestamp).ToUnixTimeMilliseconds();

        public SignalChartPoint(DateTime timestamp, decimal value)
        {
            Timestamp = timestamp;
            Value = value;
        }
    }

    // --- Trace Change Summary ---

    private static string FormatTraceChange(TraceChangeEntry prev, TraceChangeEntry curr)
    {
        var parts = new List<string>();

        if (prev.HopCount.HasValue && curr.HopCount.HasValue && prev.HopCount != curr.HopCount)
            parts.Add($"{prev.HopCount}\u2192{curr.HopCount} hops");

        if (prev.BottleneckLinkSpeedMbps.HasValue && curr.BottleneckLinkSpeedMbps.HasValue
            && Math.Abs(prev.BottleneckLinkSpeedMbps.Value - curr.BottleneckLinkSpeedMbps.Value) > 0.5)
            parts.Add($"{prev.BottleneckLinkSpeedMbps:F0}\u2192{curr.BottleneckLinkSpeedMbps:F0} Mbps");

        return parts.Count > 0 ? string.Join(", ", parts) : "Path changed";
    }

    // --- Connection Chart ---

    private class ConnectionChartPoint
    {
        public DateTime Timestamp { get; set; }
        public decimal ApIndex { get; set; }
        public string ApName { get; set; } = "";
        public long X => new DateTimeOffset(Timestamp).ToUnixTimeMilliseconds();

        public ConnectionChartPoint(DateTime ts, decimal apIndex, string apName)
        {
            Timestamp = ts;
            ApIndex = apIndex;
            ApName = apName;
        }
    }

    private void BuildConnectionChartData()
    {
        _connectionChartData.Clear();

        // Build AP name ‚Üí index mapping from events
        var apNames = _connectionEvents
            .Select(e => e.ApName ?? e.ToApName ?? "Unknown")
            .Where(n => n != "Unknown")
            .Distinct()
            .OrderBy(n => n)
            .ToList();

        if (apNames.Count == 0) return;

        var apIndex = new Dictionary<string, int>();
        for (int i = 0; i < apNames.Count; i++)
            apIndex[apNames[i]] = i;

        foreach (var evt in _connectionEvents.OrderBy(e => e.Timestamp))
        {
            var ap = evt.ApName ?? evt.ToApName ?? "Unknown";
            if (apIndex.TryGetValue(ap, out var idx))
            {
                _connectionChartData.Add(new ConnectionChartPoint(
                    evt.Timestamp.UtcDateTime, idx, ap));
            }
        }

        // Configure chart with AP names as Y categories
        _connectionChartOptions = new ApexChartOptions<ConnectionChartPoint>
        {
            Chart = new Chart { Background = "transparent", Toolbar = new Toolbar { Show = false }, Zoom = new Zoom { Enabled = false } },
            Theme = new Theme { Mode = Mode.Dark },
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels
                {
                    DatetimeFormatter = new DatetimeFormatter { Hour = "HH:mm", Day = "MMM dd" }
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Min = -0.5m,
                    Max = apNames.Count - 0.5m,
                    TickAmount = apNames.Count > 1 ? apNames.Count - 1 : 1,
                    Labels = new YAxisLabels
                    {
                        Formatter = @"function(val) {
                            var names = [" + string.Join(",", apNames.Select(n => "'" + n.Replace("'", "\\'") + "'")) + @"];
                            var idx = Math.round(val);
                            return idx >= 0 && idx < names.length ? names[idx] : '';
                        }"
                    }
                }
            },
            Colors = new List<string> { "#3b82f6" },
            Markers = new Markers { Size = 8 },
            Grid = new Grid { BorderColor = "rgba(255,255,255,0.08)" },
            Tooltip = new Tooltip { Theme = Mode.Dark },
            Legend = new Legend { Show = false }
        };
    }

    public void Dispose()
    {
        _pollTimer?.Dispose();
    }
}

<style>
    /* Page-specific layout (app.css provides .page-header, .page-description, .card, .btn*, .empty-state,
       .signal-*, .band-badge.band-*, .time-range-selector, .time-btn, .detail-label, .detail-value) */

    .client-dashboard-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 16px 32px;
    }

    /* Back link */
    .page-back-link {
        margin-bottom: 8px;
    }
    .back-link {
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
    }
    .back-link:hover {
        color: var(--text-primary);
    }
    .back-arrow {
        margin-right: 4px;
    }

    /* Loading */
    .loading-container {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-secondary);
    }

    /* Identity Hero (.card provides bg/border/radius) */
    .identity-hero {
        padding: 20px;
    }
    .hero-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    .hero-device-name {
        font-size: 1.25rem;
        margin: 0 0 4px;
    }
    .hero-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-secondary);
        font-size: 0.8125rem;
        font-family: monospace;
        flex-wrap: wrap;
    }
    .meta-separator {
        opacity: 0.5;
    }
    .hero-signal {
        flex-shrink: 0;
    }
    .signal-gauge {
        display: flex;
        align-items: baseline;
        gap: 2px;
        padding: 8px 14px;
        border-radius: 8px;
        background: var(--bg-tertiary);
    }
    .signal-value {
        font-size: 1.75rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
    }
    .signal-unit {
        font-size: 0.8125rem;
        opacity: 0.7;
    }
    .hero-details {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }
    .hero-detail-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .hero-poll-indicator {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 6px;
        margin-left: auto;
    }
    .poll-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success-color, #10b981);
        animation: pulse 2s ease-in-out infinite;
    }
    .poll-label {
        color: var(--success-color, #10b981);
        font-size: 0.75rem;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    /* Speed colors (no signal-* needed - app.css provides those) */
    .speed-excellent { color: #10b981; }
    .speed-good { color: #3b82f6; }
    .speed-fair { color: #f59e0b; }
    .speed-poor { color: #ef5858; }

    /* MLO badge (not in app.css) */
    .badge-mlo {
        padding: 0.125rem 0.5rem;
        border-radius: 3px;
        font-size: 0.7rem;
        font-weight: 500;
        background: rgba(251, 191, 36, 0.15);
        color: #fbbf24;
    }

    /* Tabs + Time Filter */
    .dashboard-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .tab-bar {
        display: flex;
        gap: 0.25rem;
        background: var(--bg-primary);
        border-radius: 6px;
        padding: 0.25rem;
    }
    .tab-btn {
        padding: 0.625rem 1.25rem;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        min-height: 44px;
        transition: all 0.15s ease;
    }
    .tab-btn:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
    }
    .tab-btn.active {
        background: var(--primary-color);
        color: white;
    }

    /* Tab content */
    .tab-content {
        min-height: 200px;
        position: relative;
    }
    .tab-loading {
        display: flex;
        justify-content: center;
        padding: 2rem 0;
    }
    .tab-pane {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Speed Hero (.card provides bg/border/radius) */
    .speed-hero {
        padding: 24px;
    }
    .speed-hero-results {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .speed-metric {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }
    .speed-label {
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
    }
    .speed-value {
        font-size: 2rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
    }
    .speed-unit {
        font-size: 0.8125rem;
        color: var(--text-secondary);
    }
    .speed-hero-meta {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: 12px;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    /* Speed Actions */
    .speed-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    /* Card content padding (.card provides bg/border/radius) */
    .chart-card,
    .results-card,
    .trace-card {
        padding: 20px;
    }
    .chart-card h3,
    .results-card h3,
    .trace-card h3 {
        margin: 0 0 12px;
        font-size: 1rem;
    }

    /* Results Table */
    .results-table-container {
        overflow-x: auto;
    }
    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8125rem;
    }
    .results-table th {
        text-align: left;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }
    .results-table td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.04);
        white-space: nowrap;
    }
    .result-row {
        cursor: pointer;
        transition: background 0.15s;
    }
    .result-row:hover {
        background: var(--bg-hover);
    }
    .result-row.expanded {
        background: var(--bg-tertiary);
    }
    .result-details-row td {
        padding: 0;
    }
    .result-details {
        padding: 16px;
        background: rgba(0,0,0,0.2);
        border-bottom: 1px solid var(--border-color);
    }

    /* Signal Hero Live (.card provides bg/border/radius) */
    .signal-hero-live {
        padding: 24px;
    }
    .signal-main {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        justify-content: center;
    }
    .signal-gauge-large {
        display: flex;
        align-items: baseline;
        gap: 4px;
    }
    .signal-value-large {
        font-size: 3rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
    }
    .signal-unit-large {
        font-size: 1rem;
        opacity: 0.7;
    }
    .signal-bars {
        display: flex;
        align-items: flex-end;
        gap: 3px;
        height: 32px;
    }
    .signal-bars .bar {
        width: 6px;
        border-radius: 2px;
        background: rgba(255,255,255,0.1);
        transition: background 0.3s;
    }
    .signal-bars .bar:nth-child(1) { height: 20%; }
    .signal-bars .bar:nth-child(2) { height: 40%; }
    .signal-bars .bar:nth-child(3) { height: 60%; }
    .signal-bars .bar:nth-child(4) { height: 80%; }
    .signal-bars .bar:nth-child(5) { height: 100%; }
    .signal-bars.signal-excellent .bar.active { background: #10b981; }
    .signal-bars.signal-good .bar.active { background: #22c55e; }
    .signal-bars.signal-fair .bar.active { background: #eab308; }
    .signal-bars.signal-weak .bar.active { background: #f97316; }
    .signal-bars.signal-poor .bar.active { background: #ef4444; }
    .signal-details-grid,
    .connection-hero-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
    }
    .signal-detail,
    .connection-detail {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    /* Connection Hero (.card provides bg/border/radius) */
    .connection-hero {
        padding: 20px;
    }

    /* Connection Event badges */
    .event-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.6875rem;
        font-weight: 500;
    }
    .event-connected {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }
    .event-disconnected {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }
    .event-roamed {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }
    .event-row-disconnect {
        opacity: 0.7;
    }
    .event-details-cell {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    /* UniFi data source indicator */
    .source-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #a78bfa;
        margin-left: 4px;
        vertical-align: middle;
    }
    .unifi-source-row {
        opacity: 0.8;
    }

    /* Skeleton loaders */
    .skeleton-hero {
        padding: 20px;
        margin-bottom: 16px;
    }
    .skeleton-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }
    .skeleton-chart {
        padding: 20px;
    }
    .skeleton-row {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        align-items: center;
    }
    .skeleton-block {
        background: linear-gradient(90deg, var(--bg-tertiary) 25%, rgba(255,255,255,0.06) 50%, var(--bg-tertiary) 75%);
        background-size: 200% 100%;
        animation: skeleton-shimmer 1.5s ease-in-out infinite;
        border-radius: 4px;
    }
    .skeleton-title { width: 200px; height: 28px; }
    .skeleton-gauge { width: 90px; height: 48px; border-radius: 8px; margin-left: auto; }
    .skeleton-detail { width: 100px; height: 36px; }
    .skeleton-tab { width: 80px; height: 44px; border-radius: 6px; }
    .skeleton-chart-area { width: 100%; height: 200px; border-radius: 4px; }

    @@keyframes skeleton-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* Sticky heroes */
    .identity-hero {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Sortable table headers */
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    .sortable:hover {
        color: var(--text-primary);
    }
    .sortable.sorted {
        color: var(--primary-color);
    }

    /* Trace change cell */
    .trace-change-cell {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    .trace-initial {
        color: var(--text-secondary);
        font-style: italic;
    }

    /* Mobile responsive */
    @@media (max-width: 768px) {
        .client-dashboard-page {
            padding: 0 12px 24px;
        }
        .dashboard-controls {
            flex-direction: column;
            align-items: stretch;
        }
        .tab-bar {
            justify-content: stretch;
        }
        .tab-btn {
            flex: 1;
            text-align: center;
        }
        .hero-main {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        .speed-hero-results {
            flex-direction: column;
            align-items: center;
        }
        .signal-details-grid, .connection-hero-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .speed-actions {
            flex-direction: column;
        }
        .speed-actions .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
