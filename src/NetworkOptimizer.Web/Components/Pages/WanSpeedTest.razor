@page "/wan-speedtest"
@rendermode InteractiveServer
@implements IDisposable
@using NetworkOptimizer.Web.Services
@using NetworkOptimizer.Storage.Models
@using NetworkOptimizer.Storage.Helpers
@using NetworkOptimizer.UniFi.Models
@using NetworkOptimizer.Web.Components.Shared
@using NetworkOptimizer.UniFi
@inject CloudflareSpeedTestService WanSpeedTestService
@inject INetworkPathAnalyzer PathAnalyzer
@inject UniFiConnectionService ConnectionService
@inject IJSRuntime JS

<PageTitle>WAN Speed Test - Network Optimizer</PageTitle>

<div class="speedtest-container wan-speedtest">
    <div class="page-header">
        <h1>WAN Speed Test</h1>
    </div>

    @* Run Test Card *@
    <div class="card">
        <div class="card-body">
            <div class="wan-test-controls">
                <button class="btn btn-primary test-button wan-test-button"
                        @onclick="RunTest"
                        disabled="@_isRunning">
                    @if (_isRunning)
                    {
                        <div class="test-progress">
                            <div class="progress-bar" style="width: @(_progressPercent)%"></div>
                        </div>
                        <span class="test-phase">@_progressPhase...</span>
                    }
                    else
                    {
                        <span>Run WAN Speed Test</span>
                    }
                </button>
                @if (!string.IsNullOrEmpty(_progressStatus))
                {
                    <div class="wan-progress-status">@_progressStatus</div>
                }

                <div class="wan-test-hint">
                    @if (_hasMultipleWans)
                    {
                        <strong>Multiple WAN connections?</strong>
                        <text>This test uses whichever WAN your gateway routes to speed.cloudflare.com.
                        To test a specific WAN, create a Policy-Based Route in UniFi targeting speed.cloudflare.com through your desired interface.</text>
                    }
                    else
                    {
                        <text>Measures your internet connection speed using Cloudflare's global edge network with 6 concurrent connections.</text>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger">@_errorMessage</div>
            }

            @if (_metadata != null)
            {
                <div class="wan-metadata">
                    <div class="metadata-item">
                        <span class="metadata-label">Edge</span>
                        <span class="metadata-value">@_metadata.Colo</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Location</span>
                        <span class="metadata-value">@_metadata.City, @_metadata.Country</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">IP</span>
                        <span class="metadata-value">@_metadata.Ip</span>
                    </div>
                </div>
            }
        </div>
    </div>

    @* Latest Result *@
    @if (_latestResult != null && _latestResult.Success)
    {
        <div class="card" id="latest-result">
            <div class="card-header">
                <h2 class="card-title">Latest Result</h2>
            </div>
            <div class="card-body">
                <SpeedTestDetails Result="_latestResult"
                                  UseWanLabels="true"
                                  OnNotesChanged="HandleNotesChanged" />
            </div>
        </div>
    }

    @* Test History *@
    <div class="card">
        <div class="card-header history-card-header">
            <div class="header-title-row">
                <h2 class="card-title">Test History</h2>
                <div class="header-actions">
                    <button class="btn btn-sm btn-secondary" @onclick="() => LoadHistory(true)" disabled="@_loadingHistory">
                        @if (_loadingHistory)
                        {
                            <span class="spinner-sm"></span>
                        }
                        else
                        {
                            <span>Refresh</span>
                        }
                    </button>
                </div>
            </div>
            @if (_testHistory.Count > 0)
            {
                <div class="history-search-row">
                    <SpeedTestSearchFilter @bind-SearchFilter="_historySearchFilter"
                                           OnSearch="OnFilterChanged"
                                           ShowStatus="true"
                                           ResultCount="_filteredHistory.Count" />
                </div>
            }
        </div>
        <div class="card-body">
            @if (_testHistory.Count > 0)
            {
                <div class="table-responsive" id="history-table">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Edge</th>
                                <th class="hide-mobile">
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        ↓ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>Download</strong><br />
                                            Data received from the internet.
                                        </span>
                                    </span>
                                </th>
                                <th class="hide-mobile">
                                    <span class="tooltip-wrapper tooltip-bottom">
                                        ↑ Mbps
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>Upload</strong><br />
                                            Data sent to the internet.
                                        </span>
                                    </span>
                                </th>
                                <th class="show-mobile">Mbps</th>
                                <th class="hide-mobile">Latency</th>
                                <th class="hide-mobile">Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in _pagedHistory)
                            {
                                var isExpanded = _expandedHistoryId == result.Id || _collapsingHistoryId == result.Id;
                                <tr id="result-@result.Id"
                                    class="@(result.Success ? "history-row-clickable" : "error-row") @(isExpanded ? "history-row-expanded" : "")"
                                    @onclick="@(async () => { if (result.Success) await ToggleHistoryExpand(result.Id); })">
                                    <td>@result.TestTime.ToLocalTime().ToString("MMM dd HH:mm")</td>
                                    <td>@(result.DeviceName ?? "Cloudflare")</td>
                                    <td class="hide-mobile">@(result.Success ? result.DownloadMbps.ToString("F1") : "-")</td>
                                    <td class="hide-mobile">@(result.Success ? result.UploadMbps.ToString("F1") : "-")</td>
                                    <td class="show-mobile">
                                        @if (result.Success)
                                        {
                                            <span>↓@result.DownloadMbps.ToString("F0") ↑@result.UploadMbps.ToString("F0")</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td class="hide-mobile">
                                        @if (result.PingMs.HasValue)
                                        {
                                            <span>@(result.PingMs.Value.ToString("F1")) ms</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td class="hide-mobile">
                                        @if (result.Success)
                                        {
                                            <span class="status-badge status-connected">OK</span>
                                        }
                                        else
                                        {
                                            <span class="status-badge status-disconnected">Failed</span>
                                            <span class="tooltip-icon tooltip-icon-sm" data-tooltip="@result.ErrorMessage">?</span>
                                        }
                                    </td>
                                    <td class="expand-chevron">
                                        @if (result.Success)
                                        {
                                            <span>@(isExpanded ? "▲" : "▼")</span>
                                        }
                                    </td>
                                </tr>
                                @if (result.Success)
                                {
                                    <tr class="history-details-row">
                                        <td colspan="8">
                                            <div class="expand-wrapper @(isExpanded ? "expanded" : "")">
                                                <div class="expand-content">
                                                    <div class="history-details">
                                                        @{
                                                            var pathAnalysis = _historyPathAnalysis.GetValueOrDefault(result.Id) ?? result.PathAnalysis;
                                                        }
                                                        <SpeedTestDetails Result="result"
                                                                          PathAnalysis="pathAnalysis"
                                                                          UseWanLabels="true"
                                                                          OnDelete="HandleDeleteResult"
                                                                          OnNotesChanged="HandleNotesChanged"
                                                                          IsInTableRow="true" />

                                                        @if (pathAnalysis == null && ConnectionService.IsConnected)
                                                        {
                                                            <div class="analyze-path-action">
                                                                <button class="btn btn-sm btn-secondary"
                                                                        @onclick="() => AnalyzeHistoricalPath(result)"
                                                                        @onclick:stopPropagation="true"
                                                                        disabled="@(_analyzingResultId == result.Id)">
                                                                    @if (_analyzingResultId == result.Id)
                                                                    {
                                                                        <span>Analyzing...</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span>Analyze Path</span>
                                                                    }
                                                                </button>
                                                                <span class="analyze-hint">Calculate network path and grade performance</span>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                @if (_historyTotalPages > 1)
                {
                    <div class="pagination" id="wan-history-pagination">
                        <button class="btn btn-sm btn-secondary" disabled="@(_historyPage <= 1)" @onclick="() => ChangePage(-1)">← Prev</button>
                        <span class="pagination-info">
                            Page @_historyPage of @_historyTotalPages (@_filteredHistory.Count@(string.IsNullOrEmpty(_historySearchFilter) ? " total" : $" of {_testHistory.Count}"))
                        </span>
                        <button class="btn btn-sm btn-secondary" disabled="@(_historyPage >= _historyTotalPages)" @onclick="() => ChangePage(1)">Next →</button>
                    </div>
                }
            }
            else if (!_loadingHistory)
            {
                <div class="empty-state">
                    <p>No WAN speed tests recorded yet.</p>
                    <p class="form-help">Click "Run WAN Speed Test" above to measure your internet connection speed via Cloudflare.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // Test state
    private bool _isRunning;
    private string _progressPhase = "";
    private int _progressPercent;
    private string? _progressStatus;
    private string? _errorMessage;
    private CloudflareSpeedTestService.CloudflareMetadata? _metadata;
    private Iperf3Result? _latestResult;
    private bool _hasMultipleWans;

    // History state
    private List<Iperf3Result> _testHistory = new();
    private bool _loadingHistory;
    private string _historySearchFilter = "";

    // Cached filtered history - recalculated via UpdateFilteredHistory() when filter or history changes
    private List<Iperf3Result> _filteredHistory = new();

    private int _historyPage = 1;
    private const int HistoryPageSize = 10;
    private int _historyTotalPages => (int)Math.Ceiling(_filteredHistory.Count / (double)HistoryPageSize);
    private IEnumerable<Iperf3Result> _pagedHistory => _filteredHistory.Skip((_historyPage - 1) * HistoryPageSize).Take(HistoryPageSize);

    private void UpdateFilteredHistory()
    {
        _filteredHistory = string.IsNullOrEmpty(_historySearchFilter)
            ? _testHistory
            : _testHistory.Where(r => SpeedTestFilterHelper.MatchesFilter(r, _historySearchFilter.ToLowerInvariant())).ToList();
    }

    // Expand state
    private int? _expandedHistoryId;
    private int? _collapsingHistoryId;

    // Path analysis state
    private Dictionary<int, PathAnalysisResult?> _historyPathAnalysis = new();
    private int? _analyzingResultId;

    // Poll timer for tracking in-progress test state
    private System.Threading.Timer? _pollTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadHistory(resetPage: true);
        if (_testHistory.Count > 0)
        {
            _latestResult = _testHistory.FirstOrDefault(r => r.Success);
        }

        // If a test is already running (user navigated away and back), start polling
        if (WanSpeedTestService.IsRunning)
        {
            _isRunning = true;
            SyncProgressFromService();
            StartPolling();
        }

        // Check if user has multiple WAN connections
        if (ConnectionService.IsConnected)
        {
            try
            {
                var networks = await ConnectionService.GetNetworksAsync();
                _hasMultipleWans = networks.Count(n => n.IsWan && n.Enabled) > 1;
            }
            catch { /* Non-critical */ }
        }

        // Subscribe to path analysis completion to refresh UI
        WanSpeedTestService.OnPathAnalysisComplete += OnPathAnalysisComplete;
    }

    private async Task RunTest()
    {
        if (_isRunning) return;

        _isRunning = true;
        _errorMessage = null;
        _metadata = null;
        _progressPhase = "Starting";
        _progressPercent = 0;
        _progressStatus = null;
        StateHasChanged();

        // Start polling for progress updates (handles navigate-away scenario)
        StartPolling();

        var result = await WanSpeedTestService.RunTestAsync(
            progress =>
            {
                _progressPhase = progress.Phase;
                _progressPercent = progress.Percent;
                // Keep last non-null status so transitional phases don't flash text
                if (progress.Status != null)
                    _progressStatus = progress.Status;
                _metadata = WanSpeedTestService.LastMetadata;
                InvokeAsync(StateHasChanged);
            });

        StopPolling();
        _isRunning = false;

        if (result != null)
        {
            if (result.Success)
            {
                _latestResult = result;
            }
            else
            {
                _errorMessage = result.ErrorMessage ?? "Test failed";
            }
        }
        else
        {
            _errorMessage = "Test was cancelled or could not start";
        }

        // Reload history to include new result
        await LoadHistory(resetPage: true);
        StateHasChanged();
    }

    private void StartPolling()
    {
        StopPolling();
        _pollTimer = new System.Threading.Timer(async _ =>
        {
            if (!WanSpeedTestService.IsRunning)
            {
                // Test finished while we were polling (navigate-away case)
                StopPolling();
                _isRunning = false;

                var lastResult = WanSpeedTestService.LastCompletedResult;
                if (lastResult != null)
                    _latestResult = lastResult;

                await InvokeAsync(async () =>
                {
                    await LoadHistory(resetPage: true);
                    StateHasChanged();
                });
                return;
            }

            SyncProgressFromService();
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromMilliseconds(500), TimeSpan.FromMilliseconds(500));
    }

    private void StopPolling()
    {
        _pollTimer?.Dispose();
        _pollTimer = null;
    }

    private void SyncProgressFromService()
    {
        var (phase, percent, status) = WanSpeedTestService.CurrentProgress;
        _progressPhase = phase;
        _progressPercent = percent;
        // Keep last non-null status (same guard as progress callback)
        if (status != null)
            _progressStatus = status;
        _metadata = WanSpeedTestService.LastMetadata;
    }

    private async Task LoadHistory(bool resetPage = false)
    {
        _loadingHistory = true;
        if (resetPage)
        {
            _historyPage = 1;
            _expandedHistoryId = null;
        }

        try
        {
            _testHistory = await WanSpeedTestService.GetResultsAsync(count: 0);
            UpdateFilteredHistory();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load history: {ex.Message}";
        }
        finally
        {
            _loadingHistory = false;
        }
    }

    private async Task ToggleHistoryExpand(int resultId)
    {
        if (_expandedHistoryId == resultId)
        {
            _expandedHistoryId = null;
        }
        else if (_expandedHistoryId.HasValue)
        {
            _collapsingHistoryId = _expandedHistoryId;
            _expandedHistoryId = resultId;
            StateHasChanged();

            await Task.Delay(50);
            _collapsingHistoryId = null;
        }
        else
        {
            _expandedHistoryId = resultId;
        }
    }

    private void OnFilterChanged(string filter)
    {
        _historyPage = 1;
        _expandedHistoryId = null;
        UpdateFilteredHistory();
        StateHasChanged();
    }

    private void ChangePage(int delta)
    {
        _historyPage += delta;
        _expandedHistoryId = null;
    }

    private async Task HandleDeleteResult(int resultId)
    {
        var deleted = await WanSpeedTestService.DeleteResultAsync(resultId);
        if (deleted)
        {
            _testHistory.RemoveAll(r => r.Id == resultId);
            UpdateFilteredHistory();
            if (_latestResult?.Id == resultId)
            {
                _latestResult = _testHistory.FirstOrDefault(r => r.Success);
            }
            if (_expandedHistoryId == resultId)
                _expandedHistoryId = null;
            _historyPathAnalysis.Remove(resultId);
            StateHasChanged();
        }
    }

    private async Task HandleNotesChanged((int Id, string? Notes) args)
    {
        await WanSpeedTestService.UpdateNotesAsync(args.Id, args.Notes);
    }

    private async Task AnalyzeHistoricalPath(Iperf3Result result)
    {
        if (_analyzingResultId != null)
            return;

        _analyzingResultId = result.Id;
        StateHasChanged();

        try
        {
            var path = await PathAnalyzer.CalculatePathAsync(result.DeviceHost, result.LocalIp);
            var analysis = PathAnalyzer.AnalyzeSpeedTest(
                path,
                result.DownloadMbps,
                result.UploadMbps,
                result.DownloadRetransmits,
                result.UploadRetransmits,
                result.DownloadBytes,
                result.UploadBytes);
            _historyPathAnalysis[result.Id] = analysis;
        }
        catch
        {
            _historyPathAnalysis[result.Id] = null;
        }
        finally
        {
            _analyzingResultId = null;
            StateHasChanged();
        }
    }

    private void OnPathAnalysisComplete(int resultId)
    {
        InvokeAsync(async () =>
        {
            // Reload history to pick up the path analysis
            await LoadHistory(resetPage: false);

            // Update latest result if it's the one that got analyzed
            if (_latestResult?.Id == resultId)
            {
                _latestResult = _testHistory.FirstOrDefault(r => r.Id == resultId) ?? _latestResult;
            }

            StateHasChanged();
        });
    }

    public void Dispose()
    {
        StopPolling();
        WanSpeedTestService.OnPathAnalysisComplete -= OnPathAnalysisComplete;
    }
}
